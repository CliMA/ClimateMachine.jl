<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tendency specification · ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TutorialList/">Home</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox" checked/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">BalanceLaws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Tendency specification</a><ul class="internal"><li><a class="tocitem" href="#Used-modules-/-imports"><span>Used modules / imports</span></a></li><li><a class="tocitem" href="#Define-a-balance-law"><span>Define a balance law</span></a></li><li><a class="tocitem" href="#Define-prognostic-variable-types"><span>Define prognostic variable types</span></a></li><li><a class="tocitem" href="#Define-some-tendency-definition-types"><span>Define some tendency definition types</span></a></li><li><a class="tocitem" href="#Testing-prognostic_vars-eq_tends"><span>Testing <code>prognostic_vars</code> <code>eq_tends</code></span></a></li><li><a class="tocitem" href="#Adding-the-tendency-specification-layer"><span>Adding the tendency specification layer</span></a></li><li><a class="tocitem" href="#Testing-the-tendency-specification-layer"><span>Testing the tendency specification layer</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Atmos/heldsuarez/">Dry Idealized GCM (Held-Suarez)</a></li><li><a class="tocitem" href="../../Atmos/burgers_single_stack/">Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../Atmos/burgers_single_stack_fvm/">Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../Atmos/densitycurrent/">LES Experiment (Density Current)</a></li><li><a class="tocitem" href="../../Atmos/risingbubble/">LES Experiment (Rising Thermal Bubble)</a></li><li><a class="tocitem" href="../../Atmos/agnesi_hs_lin/">Linear Hydrostatic Mountain (Topography)</a></li><li><a class="tocitem" href="../../Atmos/agnesi_nh_lin/">Linear Non-Hydrostatic Mountain (Topography)</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-4-1" type="checkbox"/><label class="tocitem" for="menuitem-3-4-1"><span class="docs-label">Heat</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Land/Heat/heat_equation/">Heat Equation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4-2" type="checkbox"/><label class="tocitem" for="menuitem-3-4-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Land/Soil/Water/hydraulic_functions/">Hydraulic Functions</a></li><li><a class="tocitem" href="../../Land/Soil/Heat/bonan_heat_tutorial/">Soil Heat Equation</a></li><li><a class="tocitem" href="../../Land/Soil/Water/equilibrium_test/">Richards Equation</a></li><li><a class="tocitem" href="../../Land/Soil/Coupled/equilibrium_test/">Coupled Water and Heat</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Ocean</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Ocean/geostrophic_adjustment/">One-dimensional geostrophic adjustment</a></li><li><a class="tocitem" href="../../Ocean/internal_wave/">Propagating mode-1 internal wave</a></li><li><a class="tocitem" href="../../Ocean/shear_instability/">Shear instability</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-6-1" type="checkbox"/><label class="tocitem" for="menuitem-3-6-1"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/SystemSolvers/cg/">Conjugate Gradient</a></li><li><a class="tocitem" href="../../Numerics/SystemSolvers/bgmres/">Batched Generalized Minimal Residual</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-2" type="checkbox"/><label class="tocitem" for="menuitem-3-6-2"><span class="docs-label">DG Methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/DGMethods/showcase_filters/">Filters</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-7-1" type="checkbox"/><label class="tocitem" for="menuitem-3-7-1"><span class="docs-label">Debug</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Diagnostics/Debug/StateCheck/">State Statistics Regression</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../HowToGuides/Common/UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/BalanceLaws/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Atmos/TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../../../HowToGuides/Atmos/AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../../../HowToGuides/Atmos/MoistureModelChoices/">Moisture model</a></li><li><a class="tocitem" href="../../../HowToGuides/Atmos/PrecipitationModelChoices/">Precipitation model</a></li><li><a class="tocitem" href="../../../HowToGuides/Atmos/MoistureAndPrecip/">How to create an experiment with moisture and precipitation</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-6-2" type="checkbox"/><label class="tocitem" for="menuitem-4-6-2"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6-3" type="checkbox"/><label class="tocitem" for="menuitem-4-6-3"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-7" type="checkbox"/><label class="tocitem" for="menuitem-4-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Diagnostics/UsingDiagnostics/">Using Diagnostics</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../APIs/Land/Runoff/">Runoff Parameterizations</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/FVReconstructions/">Finite Volume Reconstructions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMF_plots/">EDMF Model</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../DevDocs/ModelVariableList/">Model variable list</a></li><li><a class="tocitem" href="../../../DevDocs/ModelOutput/">Model output</a></li><li><a class="tocitem" href="../../../DevDocs/DiagnosticVariableList/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li><li><a class="tocitem" href="../../../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">BalanceLaws</a></li><li class="is-active"><a href>Tendency specification</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tendency specification</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="A-functional-tendency-specification-layer"><a class="docs-heading-anchor" href="#A-functional-tendency-specification-layer">A functional tendency specification layer</a><a id="A-functional-tendency-specification-layer-1"></a><a class="docs-heading-anchor-permalink" href="#A-functional-tendency-specification-layer" title="Permalink"></a></h1><p>In the balance law (mutating) functions, where we specify fluxes and sources,</p><ul><li><a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.flux_first_order!"><code>flux_first_order!</code></a></li><li><a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.flux_second_order!"><code>flux_second_order!</code></a></li><li>and <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.source!"><code>source!</code></a>,</li></ul><p>an additional (functional) tendency specification layer can be placed on-top that has several nice properties. The functional layer:</p><ul><li>Separates tendency definitions from which tendencies are included in a particular model.</li><li>Reduces duplicate implementations of tendency definitions (e.g., in optional submodel variants)</li><li>Allows a more flexible combination of tendencies</li><li>Allows a simple way to loop over all tendencies for all prognostic variables and recover <em>each</em> flux / source term. This will allow us a simple way to evaluate, for example, the energy budget.</li></ul><h2 id="Used-modules-/-imports"><a class="docs-heading-anchor" href="#Used-modules-/-imports">Used modules / imports</a><a id="Used-modules-/-imports-1"></a><a class="docs-heading-anchor-permalink" href="#Used-modules-/-imports" title="Permalink"></a></h2><p>Make running locally easier from ClimateMachine.jl/:</p><pre><code class="language-julia">if !(&quot;.&quot; in LOAD_PATH)
    push!(LOAD_PATH, &quot;.&quot;)
    nothing
end</code></pre><p>First, using necessary modules:</p><pre><code class="language-julia">using ClimateMachine.BalanceLaws
using ClimateMachine.VariableTemplates
using StaticArrays, Test</code></pre><p>Import methods to overload</p><pre><code class="language-julia">import ClimateMachine.BalanceLaws: prognostic_vars, eq_tends, flux</code></pre><h2 id="Define-a-balance-law"><a class="docs-heading-anchor" href="#Define-a-balance-law">Define a balance law</a><a id="Define-a-balance-law-1"></a><a class="docs-heading-anchor-permalink" href="#Define-a-balance-law" title="Permalink"></a></h2><p>Here, we define a simple balance law:</p><pre><code class="language-julia">struct MyBalanceLaw &lt;: BalanceLaw end</code></pre><h2 id="Define-prognostic-variable-types"><a class="docs-heading-anchor" href="#Define-prognostic-variable-types">Define prognostic variable types</a><a id="Define-prognostic-variable-types-1"></a><a class="docs-heading-anchor-permalink" href="#Define-prognostic-variable-types" title="Permalink"></a></h2><p>Here, we&#39;ll define some prognostic variable types, by sub-typing <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.PrognosticVariable"><code>PrognosticVariable</code></a>, for mass and energy:</p><pre><code class="language-julia">struct Mass &lt;: PrognosticVariable end
struct Energy &lt;: PrognosticVariable end</code></pre><p>Define <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.prognostic_vars"><code>prognostic_vars</code></a>, which returns <em>all</em> prognostic variables</p><pre><code class="language-julia">prognostic_vars(::MyBalanceLaw) = (Mass(), Energy());</code></pre><h2 id="Define-some-tendency-definition-types"><a class="docs-heading-anchor" href="#Define-some-tendency-definition-types">Define some tendency definition types</a><a id="Define-some-tendency-definition-types-1"></a><a class="docs-heading-anchor-permalink" href="#Define-some-tendency-definition-types" title="Permalink"></a></h2><p>Tendency definitions types are made by subtyping <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.TendencyDef"><code>TendencyDef</code></a>. There are two type parameters for <code>TendencyDef</code>. The first of which, <code>AbstractTendencyType</code>, can be either <code>Flux{FirstOrder}</code>, <code>Flux{SecondOrder}</code>, or <code>Source</code>. The second type parameter must be a subtype of <code>PrognosticVariable</code>. Tendency definitions they can be written generically and shared across all prognostic variables:</p><pre><code class="language-julia">struct Advection{PV} &lt;: TendencyDef{Flux{FirstOrder}, PV} end
struct Source1{PV} &lt;: TendencyDef{Source, PV} end
struct Source2{PV} &lt;: TendencyDef{Source, PV} end</code></pre><p>We can also permit tendency definitions to be defined for only the relevant prognostic variables: here, we restrict the second order flux, Diffusion, to be defined only for Energy. Doing this means that if we try to create <code>Diffusion{Mass}()</code>, an error will be thrown.</p><pre><code class="language-julia">struct Diffusion{PV &lt;: Energy} &lt;: TendencyDef{Flux{SecondOrder}, PV} end</code></pre><p>Define <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.eq_tends"><code>eq_tends</code></a>, which returns a tuple of tendency definitions (those sub-typed by <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.TendencyDef"><code>TendencyDef</code></a>), given</p><ul><li>the prognostic variable</li><li>the model (balance law)</li><li>the tendency type (<a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.Flux"><code>Flux</code></a> or <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.Source"><code>Source</code></a>)</li></ul><pre><code class="language-julia">#! format: off
eq_tends(pv::PV, ::MyBalanceLaw, ::Flux{FirstOrder}) where {PV &lt;: Mass} = (Advection{PV}(),);
eq_tends(pv::PV, ::MyBalanceLaw, ::Flux{FirstOrder}) where {PV &lt;: Energy} = (Advection{PV}(),);
eq_tends(pv::PV, ::MyBalanceLaw, ::Flux{SecondOrder}) where {PV &lt;: Mass} = ();
eq_tends(pv::PV, ::MyBalanceLaw, ::Flux{SecondOrder}) where {PV &lt;: Energy} = (Diffusion{PV}(),);
eq_tends(pv::PV, ::MyBalanceLaw, ::Source) where {PV &lt;: Mass} = (Source1{PV}(), Source2{PV}());
eq_tends(pv::PV, ::MyBalanceLaw, ::Source) where {PV &lt;: Energy} = (Source1{PV}(), Source2{PV}());
#! format: on</code></pre><h2 id="Testing-prognostic_vars-eq_tends"><a class="docs-heading-anchor" href="#Testing-prognostic_vars-eq_tends">Testing <code>prognostic_vars</code> <code>eq_tends</code></a><a id="Testing-prognostic_vars-eq_tends-1"></a><a class="docs-heading-anchor-permalink" href="#Testing-prognostic_vars-eq_tends" title="Permalink"></a></h2><p>To test that <code>prognostic_vars</code> and <code>eq_tends</code> were implemented correctly, we&#39;ll create a balance law instance and call <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.show_tendencies"><code>show_tendencies</code></a>, to make sure that the tendency table is accurate.</p><pre><code class="language-julia">bl = MyBalanceLaw()
show_tendencies(bl; table_complete = true)</code></pre><pre class="documenter-example-output">
PDE: ∂_t Y_i + (∇•F_1(Y))_i + (∇•F_2(Y,G)))_i = (S(Y,G))_i
┌──────────┬──────────────────┬───────────────────┬────────────────────┐
│ Equation │ Flux{FirstOrder} │ Flux{SecondOrder} │             Source │
│    (Y_i) │            (F_1) │             (F_2) │                (S) │
├──────────┼──────────────────┼───────────────────┼────────────────────┤
│     Mass │      (Advection) │                () │ (Source1, Source2) │
│   Energy │      (Advection) │       (Diffusion) │ (Source1, Source2) │
└──────────┴──────────────────┴───────────────────┴────────────────────┘</pre><p>The table looks correct. Now we&#39;re ready to add the specification layer.</p><h2 id="Adding-the-tendency-specification-layer"><a class="docs-heading-anchor" href="#Adding-the-tendency-specification-layer">Adding the tendency specification layer</a><a id="Adding-the-tendency-specification-layer-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-the-tendency-specification-layer" title="Permalink"></a></h2><p>For the purpose of this tutorial, we&#39;ll only focus on adding the layer to the first order flux, since doing so for the second order flux and source functions follow the same exact pattern. In other words, we&#39;ll add a layer that tests the <code>Flux{FirstOrder}</code> column in the table above. First, we&#39;ll define individual <a href="../../../APIs/BalanceLaws/BalanceLaws/#ClimateMachine.BalanceLaws.flux"><code>flux</code></a> kernels:</p><pre><code class="language-julia">flux(::Advection{Mass}, bl::MyBalanceLaw, args) =
    args.state.ρ * SVector(1, 1, 1);
flux(::Advection{Energy}, bl::MyBalanceLaw, args) =
    args.state.ρe * SVector(1, 1, 1);</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><ul><li><code>flux</code> should return a 3-componet vector for scalar equations</li><li><code>flux</code> should return a 3xN-componet tensor for N-component vector equations</li><li><code>source</code> should return a scalar for scalar equations</li><li><code>source</code> should return a N-componet vector for N-component vector equations</li></ul></div></div><p>Define <code>flux_first_order!</code> and utilize <code>eq_tends</code></p><pre><code class="language-julia">function flux_first_order!(
    bl::MyBalanceLaw,
    flx::Grad,
    state::Vars,
    aux,
    t,
    direction,
)

    tend_type = Flux{FirstOrder}()
    args = (; state, aux, t, direction)

    # `Σfluxes(Mass(), eq_tends(Mass(), bl, tend_type), bl, args)` calls
    # `flux(::Advection{Mass}, ...)` defined above:
    eqt_ρ = eq_tends(Mass(), bl, tend_type)
    flx.ρ = Σfluxes(Mass(), eqt_ρ, bl, args)

    # `Σfluxes(Energy(), eq_tends(Energy(), bl, tend_type), bl, args)` calls
    # `flux(::Advection{Energy}, ...)` defined above:
    eqt_ρe = eq_tends(Energy(), bl, tend_type)
    flx.ρe = Σfluxes(Energy(), eqt_ρe, bl, args)
    return nothing
end;</code></pre><h2 id="Testing-the-tendency-specification-layer"><a class="docs-heading-anchor" href="#Testing-the-tendency-specification-layer">Testing the tendency specification layer</a><a id="Testing-the-tendency-specification-layer-1"></a><a class="docs-heading-anchor-permalink" href="#Testing-the-tendency-specification-layer" title="Permalink"></a></h2><p>Now, let&#39;s test <code>flux_first_order!</code> we need to initialize some dummy data to call it first:</p><pre><code class="language-julia">FT = Float64; # float type
aux = (); # auxiliary fields
t = 0.0; # time
direction = nothing; # Direction

state = Vars{@vars(ρ::FT, ρe::FT)}([1, 2]);
flx = Grad{@vars(ρ::FT, ρe::FT)}(zeros(MArray{Tuple{3, 2}, FT}));</code></pre><p>call <code>flux_first_order!</code></p><pre><code class="language-julia">flux_first_order!(bl, flx, state, aux, t, direction);</code></pre><p>Test that <code>flx</code> has been properly mutated:</p><pre><code class="language-julia">@testset &quot;Test results&quot; begin
    @test flx.ρ == [1, 1, 1]
    @test flx.ρe == [2, 2, 2]
end</code></pre><pre class="documenter-example-output">Test.DefaultTestSet(&quot;Test results&quot;, Any[], 2, false)</pre><div class="admonition is-success"><header class="admonition-header">Tip</header><div class="admonition-body"><p>A useful pattern for finding tendency definitions is to globally search for, for example, <code>::Gravity{Momentum</code> or <code>::Gravity{</code>.</p></div></div><pre><code class="language-julia">nothing</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../TutorialList/">« Home</a><a class="docs-footer-nextpage" href="../../Atmos/heldsuarez/">Dry Idealized GCM (Held-Suarez) »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 3 March 2021 14:55">Wednesday 3 March 2021</span>. Using Julia version 1.5.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
