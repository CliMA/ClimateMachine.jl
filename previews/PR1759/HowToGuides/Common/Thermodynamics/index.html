<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Thermodynamics · ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><span class="tocitem">Tutorials</span></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Thermodynamics</a><ul class="internal"><li><a class="tocitem" href="#Usage"><span>Usage</span></a></li><li><a class="tocitem" href="#Extending"><span>Extending</span></a></li><li><a class="tocitem" href="#Tested-Profiles"><span>Tested Profiles</span></a></li><li><a class="tocitem" href="#Input-space-exploration"><span>Input space exploration</span></a></li><li><a class="tocitem" href="#Converged-cases-(3D-view)"><span>Converged cases (3D view)</span></a></li><li><a class="tocitem" href="#Non-converged-cases-(3D-view)"><span>Non-converged cases (3D view)</span></a></li><li><a class="tocitem" href="#Converged-cases-(2D-view),-binned-by-total-specific-humidity"><span>Converged cases (2D view), binned by total specific humidity</span></a></li><li><a class="tocitem" href="#Non-converged-cases-(2D-view),-binned-by-total-specific-humidity"><span>Non-converged cases (2D view), binned by total specific humidity</span></a></li></ul></li><li><a class="tocitem" href="../UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Atmos/TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../../Atmos/AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../../Atmos/MoistureModelChoices/">Moisture model</a></li><li><a class="tocitem" href="../../Atmos/PrecipitationModelChoices/">Precipitation model</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-5-2" type="checkbox"/><label class="tocitem" for="menuitem-4-5-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/DGMethods/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-3" type="checkbox"/><label class="tocitem" for="menuitem-4-5-3"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-4" type="checkbox"/><label class="tocitem" for="menuitem-4-5-4"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Diagnostics/UsingDiagnostics/">Using Diagnostics</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../DevDocs/ModelVariableList/">Model variable list</a></li><li><a class="tocitem" href="../../../DevDocs/ModelOutput/">Model output</a></li><li><a class="tocitem" href="../../../DevDocs/DiagnosticVariableList/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li><li><a class="tocitem" href="../../../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to-guides</a></li><li><a class="is-disabled">Common</a></li><li class="is-active"><a href>Thermodynamics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Thermodynamics</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/blob/master/docs/src/HowToGuides/Common/Thermodynamics.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Thermodynamics-docs"><a class="docs-heading-anchor" href="#Thermodynamics-docs">Thermodynamics Module</a><a id="Thermodynamics-docs-1"></a><a class="docs-heading-anchor-permalink" href="#Thermodynamics-docs" title="Permalink"></a></h1><p>Thermodynamics.jl provides all thermodynamic functions needed for the atmosphere and functions shared across model components. The functions are general for a moist atmosphere that includes suspended cloud condensate in the working fluid; the special case of a dry atmosphere is obtained for zero specific humidities (or simply by omitting the optional specific humidity arguments in the functions that are needed for a dry atmosphere). The general formulation assumes that there are tracers for specific humidity <code>q</code>, partitioned into</p><ul><li><code>q.tot</code> total water specific humidity</li><li><code>q.liq</code> liquid specific humidity</li><li><code>q.ice</code> ice specific humidity</li></ul><p>to characterize the thermodynamic state and composition of moist air.</p><p>There are several types of functions:</p><ol><li>Equation of state (ideal gas law):<ul><li><code>air_pressure</code></li></ul></li><li>Specific gas constant and isobaric and isochoric specific heats of moist air:<ul><li><code>gas_constant_air</code></li><li><code>cp_m</code></li><li><code>cv_m</code></li></ul></li><li>Specific latent heats of vaporization, fusion, and sublimation:<ul><li><code>latent_heat_vapor</code></li><li><code>latent_heat_fusion</code></li><li><code>latent_heat_sublim</code></li></ul></li><li>Saturation vapor pressure and specific humidity over liquid and ice:<ul><li><code>sat_vapor_press_liquid</code></li><li><code>sat_vapor_press_ice</code></li><li><code>sat_shum</code></li></ul></li><li>Functions computing energies and inverting them to obtain temperatures<ul><li><code>total_energy</code></li><li><code>internal_energy</code></li><li><code>air_temperature</code></li></ul></li><li>Functions to compute temperatures and partitioning of water into phases in thermodynamic equilibrium (when Gibbs&#39; phase rule implies that the entire thermodynamic state of moist air, including the liquid and ice specific humidities, can be calculated from the 3 thermodynamic state variables, such as energy, pressure, and total specific humidity)<ul><li><code>liquid_fraction</code> (fraction of condensate that is liquid)</li><li><code>saturation_adjustment</code> (compute temperature from energy, density, and total specific humidity)</li></ul></li><li>Auxiliary functions for diagnostic purposes, e.g., other thermodynamic</li></ol><p>quantities     * <code>liquid_ice_pottemp</code> (liquid-ice potential temperature)</p><p>A moist dynamical core that assumes equilibrium thermodynamics can be obtained from a dry dynamical core with total energy as a prognostic variable by including a tracer for the total specific humidity <code>q.tot</code>, using the functions, e.g., for the energies in the module, and computing the temperature <code>T</code> and the liquid and ice specific humidities (<code>q.liq</code> and <code>q.ice</code>) from the internal energy <code>e_int</code> by saturation adjustment.</p><h2 id="Usage"><a class="docs-heading-anchor" href="#Usage">Usage</a><a id="Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Usage" title="Permalink"></a></h2><p>Users are encouraged to first establish a thermodynamic state with one of our <a href="../../../APIs/Common/Thermodynamics/#Thermodynamic-State-Constructors">Thermodynamic State Constructors</a>. For example, we would construct a moist thermodynamic state using</p><pre><code class="language-julia">ts = PhaseEquil(param_set, e_int, ρ, q_tot);</code></pre><p>here, <code>ρ</code> is the density of the moist air, and the internal energy <code>e_int = e_tot - e_kin - geopotential</code> is the total energy <code>e_tot</code> minus kinetic energy <code>e_kin</code> and potential energy <code>geopotential</code> (all energies per unit mass). Once we&#39;ve established a thermodynamic state, we can call <a href="../../../APIs/Common/Thermodynamics/#Thermodynamic-state-methods">Thermodynamic state methods</a> that support thermodynamic states:</p><pre><code class="language-julia">T = air_temperature(ts);
q = PhasePartition(ts);</code></pre><p>No changes to the &quot;right-hand sides&quot; of the dynamical equations are needed for a moist dynamical core that supports clouds, as long as they do not precipitate. Additional source-sink terms arise from precipitation.</p><p>Schematically, the workflow in such a core would look as follows:</p><pre><code class="language-julia"># initialize
geopotential = grav * z
q_tot          = ...
ρ            = ...

(u, v, w)    = ...
e_kin           = 0.5 * (u^2 + v^2 + w^2)

e_tot        = total_energy(e_kin, geopotential, T, q_tot)

do timestep   # timestepping loop

  # advance dynamical variables by a timestep (temperature typically
  # appears in terms on the rhs, such as radiative transfer)
  advance(u, v, w, ρ, e_tot, q_tot)

  # compute internal energy from dynamic variables
  e_int = e_tot - 0.5 * (u^2 + v^2 + w^2) - geopotential

  # compute temperature, pressure and condensate specific humidities,
  ts = PhaseEquil(param_set, e_int, ρ, q_tot);
  T = air_temperature(ts);
  q = PhasePartition(ts);
  p = air_pressure(ts);

end</code></pre><p>For a dynamical core that additionally uses the liquid and ice specific humidities <code>q.liq</code> and <code>q.ice</code> as prognostic variables, and thus explicitly allows the presence of non-equilibrium phases such as supercooled water, the saturation adjustment in the above workflow is replaced calling a non-equilibrium moist thermodynamic state:</p><pre><code class="language-julia">q_tot, q_liq, q_ice = ...
ts = PhaseNonEquil(param_set, e_int, ρ, PhasePartition(q_tot, q_liq, q_ice));
T = air_temperature(ts);
p = air_pressure(ts);</code></pre><h2 id="Extending"><a class="docs-heading-anchor" href="#Extending">Extending</a><a id="Extending-1"></a><a class="docs-heading-anchor-permalink" href="#Extending" title="Permalink"></a></h2><p>If Thermodynamics.jl does not have a particular thermodynamic constructor that is needed, you can implement a new one in <code>src/Common/Thermodynamics/states.jl</code>. In this constructor, you must add whichever arguments you wish to offer as inputs, then translate this thermodynamic state into one of:</p><ul><li><code>PhaseDry</code> a dry thermodynamic state, uniquely determined by two independent thermodynamic properties</li><li><code>PhaseEquil</code> a moist thermodynamic state in thermodynamic equilibrium, uniquely determined by three independent thermodynamic properties</li><li><code>PhaseNonEquil</code> a moist thermodynamic state in thermodynamic non-equilibrium, uniquely determined by four independent thermodynamic properties</li></ul><h2 id="Tested-Profiles"><a class="docs-heading-anchor" href="#Tested-Profiles">Tested Profiles</a><a id="Tested-Profiles-1"></a><a class="docs-heading-anchor-permalink" href="#Tested-Profiles" title="Permalink"></a></h2><p>Thermodynamics.jl is tested using a set of profiles specified in <code>test/Common/Thermodynamics/profiles.jl</code>.</p><h3 id="Dry-Phase"><a class="docs-heading-anchor" href="#Dry-Phase">Dry Phase</a><a id="Dry-Phase-1"></a><a class="docs-heading-anchor-permalink" href="#Dry-Phase" title="Permalink"></a></h3><pre><code class="language-julia">using ClimateMachine.Thermodynamics
using ClimateMachine.TemperatureProfiles
using UnPack
using CLIMAParameters
using CLIMAParameters.Planet
using Plots
struct EarthParameterSet &lt;: AbstractEarthParameterSet end;
const param_set = EarthParameterSet();
include(joinpath(@__DIR__, repeat([&quot;..&quot;], 4)...,&quot;test&quot;, &quot;Common&quot;, &quot;Thermodynamics&quot;, &quot;profiles.jl&quot;))
profiles = PhaseDryProfiles(param_set, Array{Float32});
@unpack T, ρ, z = profiles
p1 = scatter(ρ, z./10^3, xlabel=&quot;Density [kg/m^3]&quot;, ylabel=&quot;z [km]&quot;, title=&quot;Density&quot;);
p2 = scatter(T, z./10^3, xlabel=&quot;Temperature [K]&quot;, ylabel=&quot;z [km]&quot;, title=&quot;Temperature&quot;);
plot(p1, p2, layout=(1,2))
savefig(&quot;tested_profiles_dry.svg&quot;);</code></pre><p><img src="../tested_profiles_dry.svg" alt/></p><h3 id="Moist-Phase-in-thermodynamic-equilibrium"><a class="docs-heading-anchor" href="#Moist-Phase-in-thermodynamic-equilibrium">Moist Phase in thermodynamic equilibrium</a><a id="Moist-Phase-in-thermodynamic-equilibrium-1"></a><a class="docs-heading-anchor-permalink" href="#Moist-Phase-in-thermodynamic-equilibrium" title="Permalink"></a></h3><pre><code class="language-julia">using ClimateMachine.Thermodynamics
using ClimateMachine.TemperatureProfiles
using UnPack
using CLIMAParameters
using CLIMAParameters.Planet
using Plots
struct EarthParameterSet &lt;: AbstractEarthParameterSet end;
const param_set = EarthParameterSet();
include(joinpath(@__DIR__, repeat([&quot;..&quot;], 4)...,&quot;test&quot;, &quot;Common&quot;, &quot;Thermodynamics&quot;, &quot;profiles.jl&quot;))
profiles = PhaseEquilProfiles(param_set, Array{Float32});
@unpack T, ρ, q_tot, z = profiles
p1 = scatter(ρ, z./10^3, xlabel=&quot;Density [kg/m^3]&quot;, ylabel=&quot;z [km]&quot;, title=&quot;Density&quot;);
p2 = scatter(T, z./10^3, xlabel=&quot;Temperature [K]&quot;, ylabel=&quot;z [km]&quot;, title=&quot;Temperature&quot;);
p3 = scatter(q_tot*1000, z./10^3, xlabel=&quot;Total specific\nhumidity [g/kg]&quot;, ylabel=&quot;z [km]&quot;, title=&quot;Total specific\nhumidity&quot;);
plot(p1, p2, p3, layout=(1,3))
savefig(&quot;tested_profiles_virt_temp.svg&quot;)</code></pre><p><img src="../tested_profiles_virt_temp.svg" alt/></p><h2 id="Input-space-exploration"><a class="docs-heading-anchor" href="#Input-space-exploration">Input space exploration</a><a id="Input-space-exploration-1"></a><a class="docs-heading-anchor-permalink" href="#Input-space-exploration" title="Permalink"></a></h2><p>In the previous section, we plotted the tested thermodynamic states. In this section, we explore the convergence of the input space beyond what is tested. In particular, rather than being interested in physically meaningful combinations of constructor inputs (e.g., <code>ρ, e_int, q_tot</code>), we are interested in all permutations of inputs within a given range of <code>ρ, e_int, q_tot</code>. Some of these permutations may not be physically meaningful, or likely to be observed in climate simulations, but showing the convergence space helps illustrate the buffer between our tested profiles and the nearest space where convergence fails.</p><pre><code class="language-julia">using ClimateMachine.Thermodynamics
using ClimateMachine.TemperatureProfiles
using UnPack
using CLIMAParameters
using CLIMAParameters.Planet
using Plots
import ClimateMachine.Thermodynamics
Thermodynamics.print_warning() = false

struct EarthParameterSet &lt;: AbstractEarthParameterSet end;
const param_set = EarthParameterSet();
FT = Float64;
clima_root = joinpath(@__DIR__, repeat([&quot;..&quot;], 4)...);
include(joinpath(clima_root, &quot;test&quot;, &quot;Common&quot;, &quot;Thermodynamics&quot;, &quot;profiles.jl&quot;))
include(joinpath(clima_root, &quot;docs&quot;, &quot;plothelpers.jl&quot;));
profiles = PhaseEquilProfiles(param_set, Array{FT});
@unpack ρ, e_int, q_tot = profiles

dims = (10, 10, 10);
ρ = range(min(ρ...), stop=max(ρ...), length=dims[1]);
e_int = range(min(e_int...), stop=max(e_int...), length=dims[2]);
q_tot = range(min(q_tot...), stop=max(q_tot...), length=dims[3]);

ρ_all = Array{FT}(undef, prod(dims));
e_int_all = Array{FT}(undef, prod(dims));
q_tot_all = Array{FT}(undef, prod(dims));

linear_indices = LinearIndices((1:dims[1], 1:dims[2], 1:dims[3]));
TS = Array{Union{ThermodynamicState, Nothing}}(undef, prod(dims));
TS_no_err = Array{ThermodynamicState}(undef, prod(dims));

@inbounds for i in linear_indices.indices[1]
    @inbounds for j in linear_indices.indices[2]
        @inbounds for k in linear_indices.indices[3]
            p = linear_indices[i, j, k];
            ρ_all[p] = ρ[i];
            e_int_all[p] = e_int[j];
            q_tot_all[p] = q_tot[k];

            Thermodynamics.error_on_non_convergence() = false
            TS_no_err[p] = PhaseEquil(param_set, e_int[j], ρ[i], q_tot[k]);
            Thermodynamics.error_on_non_convergence() = true
            # @show p/prod(linear_indices.indices)*100
            try
                TS[p] = PhaseEquil(param_set, e_int[j], ρ[i], q_tot[k]);
            catch
                TS[p] = nothing
            end
        end
    end
end

# Full 3D scatter plot
function save_masked_plot3D(TS_no_err, mask, title, filename)
    ρ_mask = ρ_all[mask];
    T_mask = air_temperature.(TS_no_err[mask]);
    q_tot_mask = q_tot_all[mask];
    pts = (ρ_mask, T_mask, q_tot_mask)
    Plots.plot(pts..., seriestype=:scatter, markersize = 7)
    plot!(xlabel=&quot;Density&quot;,
          ylabel=&quot;Temperature&quot;,
          zlabel=&quot;Total specific humidity&quot;,
          title=&quot;$title&quot;)
    savefig(filename)
end;

save_masked_plot3D(TS_no_err, TS .== nothing, &quot;NC&quot;, &quot;Scatter3DNonConverged.svg&quot;);
save_masked_plot3D(TS_no_err, TS .!= nothing, &quot;C&quot;, &quot;Scatter3DConverged.svg&quot;);

# 2D binned scatter plots
function save_masked_plot2D_slices(TS_no_err, mask, title, filename)
    ρ_mask = ρ_all[mask];
    T_mask = air_temperature.(TS_no_err[mask]);
    q_tot_mask = q_tot_all[mask];
    save_binned_surface_plots(ρ_mask, T_mask, q_tot_mask, title, filename)
end;

save_masked_plot2D_slices(TS_no_err, TS .== nothing, &quot;NC&quot;, &quot;Slices2DNonConverged.svg&quot;);
save_masked_plot2D_slices(TS_no_err, TS .!= nothing, &quot;C&quot;, &quot;Slices2DConverged.svg&quot;);

@warn &quot;Note that the temperature axis for the non-converged
plot is not necessarily accurate, since the temperatures are
the result of a non-converged saturation adjustment&quot;</code></pre><pre class="documenter-example-output">┌ Warning: Note that the temperature axis for the non-converged
│ plot is not necessarily accurate, since the temperatures are
│ the result of a non-converged saturation adjustment
└ @ Main.##ex-#380 none:2</pre><h2 id="Converged-cases-(3D-view)"><a class="docs-heading-anchor" href="#Converged-cases-(3D-view)">Converged cases (3D view)</a><a id="Converged-cases-(3D-view)-1"></a><a class="docs-heading-anchor-permalink" href="#Converged-cases-(3D-view)" title="Permalink"></a></h2><p><img src="../Scatter3DConverged.svg" alt/></p><h2 id="Non-converged-cases-(3D-view)"><a class="docs-heading-anchor" href="#Non-converged-cases-(3D-view)">Non-converged cases (3D view)</a><a id="Non-converged-cases-(3D-view)-1"></a><a class="docs-heading-anchor-permalink" href="#Non-converged-cases-(3D-view)" title="Permalink"></a></h2><p><img src="../Scatter3DNonConverged.svg" alt/></p><h2 id="Converged-cases-(2D-view),-binned-by-total-specific-humidity"><a class="docs-heading-anchor" href="#Converged-cases-(2D-view),-binned-by-total-specific-humidity">Converged cases (2D view), binned by total specific humidity</a><a id="Converged-cases-(2D-view),-binned-by-total-specific-humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Converged-cases-(2D-view),-binned-by-total-specific-humidity" title="Permalink"></a></h2><p><img src="../Slices2DConverged.svg" alt/></p><h2 id="Non-converged-cases-(2D-view),-binned-by-total-specific-humidity"><a class="docs-heading-anchor" href="#Non-converged-cases-(2D-view),-binned-by-total-specific-humidity">Non-converged cases (2D view), binned by total specific humidity</a><a id="Non-converged-cases-(2D-view),-binned-by-total-specific-humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Non-converged-cases-(2D-view),-binned-by-total-specific-humidity" title="Permalink"></a></h2><p><img src="../Slices2DNonConverged.svg" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../GettingStarted/Atmos/">« Atmosphere model configurations</a><a class="docs-footer-nextpage" href="../UniversalFunctions/">Universal Functions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 24 November 2020 18:19">Tuesday 24 November 2020</span>. Using Julia version 1.5.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
