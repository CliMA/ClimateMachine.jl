<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>State Statistics Regression · ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../TutorialList/">Home</a></li><li><a class="tocitem" href="../../../how_to_make_a_balance_law/">Balance Law</a></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Atmos/heldsuarez/">Dry Idealized GCM (Held-Suarez)</a></li><li><a class="tocitem" href="../../../Atmos/burgers_single_stack/">Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../../Atmos/densitycurrent/">LES Experiment (Density Current)</a></li><li><a class="tocitem" href="../../../Atmos/risingbubble/">LES Experiment (Rising Thermal Bubble)</a></li><li><a class="tocitem" href="../../../Atmos/agnesi_hs_lin/">Linear Hydrostatic Mountain (Topography)</a></li><li><a class="tocitem" href="../../../Atmos/agnesi_nh_lin/">Linear Non-Hydrostatic Mountain (Topography)</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-5-1" type="checkbox"/><label class="tocitem" for="menuitem-3-5-1"><span class="docs-label">Heat</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Land/Heat/heat_equation/">Heat Equation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-2" type="checkbox"/><label class="tocitem" for="menuitem-3-5-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Land/Soil/Water/hydraulic_functions/">Hydraulic Functions</a></li><li><a class="tocitem" href="../../../Land/Soil/Heat/bonan_heat_tutorial/">Soil Heat Equation</a></li><li><a class="tocitem" href="../../../Land/Soil/Coupled/equilibrium_test/">Coupled Water and Heat</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-6-1" type="checkbox"/><label class="tocitem" for="menuitem-3-6-1"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Numerics/SystemSolvers/cg/">Conjugate Gradient</a></li><li><a class="tocitem" href="../../../Numerics/SystemSolvers/bgmres/">Batched Generalized Minimal Residual</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-2" type="checkbox"/><label class="tocitem" for="menuitem-3-6-2"><span class="docs-label">DG Methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Numerics/DGMethods/showcase_filters/">Filters</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox" checked/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-7-1" type="checkbox" checked/><label class="tocitem" for="menuitem-3-7-1"><span class="docs-label">Debug</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>State Statistics Regression</a><ul class="internal"><li><a class="tocitem" href="#.-Generating-statistics-for-a-set-of-MPIStateArrays"><span>1. Generating statistics for a set of MPIStateArrays</span></a></li><li><a class="tocitem" href="#.-Comparing-to-reference-values"><span>2. Comparing to reference values</span></a></li></ul></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../../HowToGuides/Common/UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Atmos/TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/MoistureModelChoices/">Moisture model</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-5-2" type="checkbox"/><label class="tocitem" for="menuitem-4-5-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Numerics/DGMethods/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-3" type="checkbox"/><label class="tocitem" for="menuitem-4-5-3"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-4" type="checkbox"/><label class="tocitem" for="menuitem-4-5-4"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../../DevDocs/VariableList/">Variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/DiagnosticVariables/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Diagnostics</a></li><li><a class="is-disabled">Debug</a></li><li class="is-active"><a href>State Statistics Regression</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>State Statistics Regression</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/blob/master/tutorials/Diagnostics/Debug/StateCheck.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="State-debug-statistics"><a class="docs-heading-anchor" href="#State-debug-statistics">State debug statistics</a><a id="State-debug-statistics-1"></a><a class="docs-heading-anchor-permalink" href="#State-debug-statistics" title="Permalink"></a></h1><p>This page shows how to use the <code>StateCheck</code> functions to get basic statistics for nodal values of fields held in ClimateMachine <code>MPIStateArray</code> data structures. The <code>StateCheck</code> functions can be used to</p><ol><li><p>Generate statistics on <code>MPIStateArray</code> holding the state of a ClimateMachine experiment.</p><p>and to</p></li><li><p>Compare against saved reference statistics from ClimateMachine <code>MPIStateArray</code> variables. This can enable simple automated regression test checks for detecting unexpected changes introduced into numerical experiments by code updates.</p></li></ol><p>These two cases are shown below:</p><h2 id=".-Generating-statistics-for-a-set-of-MPIStateArrays"><a class="docs-heading-anchor" href="#.-Generating-statistics-for-a-set-of-MPIStateArrays">1. Generating statistics for a set of MPIStateArrays</a><a id=".-Generating-statistics-for-a-set-of-MPIStateArrays-1"></a><a class="docs-heading-anchor-permalink" href="#.-Generating-statistics-for-a-set-of-MPIStateArrays" title="Permalink"></a></h2><p>Here we create a callback that can generate statistics for an arbitrary set of the MPIStateArray type variables of the sort that hold persistent state for ClimateMachine models. We then invoke the call back to show the statistics.</p><p>In regular use the <code>MPIStateArray</code> variables will come from model configurations. Here we create a dummy set of <code>MPIStateArray</code> variables for use in stand alone examples.</p><h3 id="Create-a-dummy-set-of-MPIStateArrays"><a class="docs-heading-anchor" href="#Create-a-dummy-set-of-MPIStateArrays">Create a dummy set of MPIStateArrays</a><a id="Create-a-dummy-set-of-MPIStateArrays-1"></a><a class="docs-heading-anchor-permalink" href="#Create-a-dummy-set-of-MPIStateArrays" title="Permalink"></a></h3><p>First we set up two <code>MPIStateArray</code> variables. This need a few packages to be in placeT, and utilizes some utility functions to create the array and add named persistent state variables. This is usually handled automatically as part of model definition in regular ClimateMachine activity. Calling <code>ClimateMachine.init()</code> includes initializing GPU CUDA and MPI parallel processing options that match the hardware/software system in use.</p><p>Set up a basic environment</p><pre><code class="language-julia">using MPI
using StaticArrays
using Random
using ClimateMachine
using ClimateMachine.VariableTemplates
using ClimateMachine.MPIStateArrays
using ClimateMachine.GenericCallbacks
using ClimateMachine.StateCheck

ClimateMachine.init()
FT = Float64</code></pre><pre class="documenter-example-output">Float64</pre><p>Define some dummy vector and tensor abstract variables with associated types and dimensions</p><pre><code class="language-julia">F1 = @vars begin
    ν∇u::SMatrix{3, 2, FT, 6}
    κ∇θ::SVector{3, FT}
end
F2 = @vars begin
    u::SVector{2, FT}
    θ::SVector{1, FT}
end</code></pre><p>Create <code>MPIStateArray</code> variables with arrays to hold elements of the vectors and tensors</p><pre><code class="language-julia">Q1 = MPIStateArray{Float32, F1}(
    MPI.COMM_WORLD,
    ClimateMachine.array_type(),
    4,
    9,
    8,
)
Q2 = MPIStateArray{Float64, F2}(
    MPI.COMM_WORLD,
    ClimateMachine.array_type(),
    4,
    3,
    8,
)</code></pre><h3 id="Create-a-call-back"><a class="docs-heading-anchor" href="#Create-a-call-back">Create a call-back</a><a id="Create-a-call-back-1"></a><a class="docs-heading-anchor-permalink" href="#Create-a-call-back" title="Permalink"></a></h3><p>Now we can create a <code>StateCheck</code> call-back, <em>cb</em>, tied to the <code>MPIStateArray</code> variables <em>Q1</em> and <em>Q2</em>. Each <code>MPIStateArray</code> in the array of <code>MPIStateArray</code> variables tracked is paired with a label to identify it. The call-back is also given a frequency (in time step numbers) and precision for printing summary tables.</p><pre><code class="language-julia">cb = ClimateMachine.StateCheck.sccreate(
    [(Q1, &quot;My gradients&quot;), (Q2, &quot;My fields&quot;)],
    1;
    prec = 15,
)
GenericCallbacks.init!(cb, nothing, nothing, nothing, nothing)</code></pre><pre class="documenter-example-output"># SC Start: creating state check callback
# SC Creating state check callback labeled &quot;My gradients&quot; for symbols
# SC ν∇u
# SC κ∇θ
# SC Creating state check callback labeled &quot;My fields&quot; for symbols
# SC u
# SC θ
# SC Finish: creating state check callback</pre><h3 id="Invoke-the-call-back"><a class="docs-heading-anchor" href="#Invoke-the-call-back">Invoke the call-back</a><a id="Invoke-the-call-back-1"></a><a class="docs-heading-anchor-permalink" href="#Invoke-the-call-back" title="Permalink"></a></h3><p>The call-back is of type <code>ClimateMachine.GenericCallbacks.EveryXSimulationSteps</code> and in regular use is designed to be passed to a ClimateMachine timestepping solver e.g.</p><pre><code class="language-julia">typeof(cb)</code></pre><pre class="documenter-example-output">ClimateMachine.GenericCallbacks.EveryXSimulationSteps</pre><p>Here, for demonstration purposes, we can invoke the call-back after simply initializing the <code>MPIStateArray</code> fields to a random set of values e.g.</p><pre><code class="language-julia">Q1.data .= rand(MersenneTwister(0), Float32, size(Q1.data))
Q2.data .= rand(MersenneTwister(0), Float64, size(Q2.data))
GenericCallbacks.call!(cb, nothing, nothing, nothing, nothing)</code></pre><pre class="documenter-example-output"># SC +++++++++++ClimateMachine StateCheck call-back start+++++++++++++++++
# SC  Step  |   Label    |  Field   |                            Stats
# SC -------|------------|----------|                 min() |                 max() |                mean() |                 std() |
# SC 0000000|My gradients|   ν∇u[1] |  1.343488693237305e-04|  9.847328662872314e-01|  5.235455036163330e-01|  3.082099258899689e-01|
# SC 0000000|My gradients|   ν∇u[2] |  1.163178682327271e-01|  9.920883178710938e-01|  4.838006496429443e-01|  2.833504378795624e-01|
# SC 0000000|My gradients|   ν∇u[3] |  1.058459281921387e-03|  9.517759084701538e-01|  4.654744267463684e-01|  2.736155688762665e-01|
# SC 0000000|My gradients|   ν∇u[4] |  5.976688861846924e-02|  9.680480957031250e-01|  5.426180362701416e-01|  2.815708518028259e-01|
# SC 0000000|My gradients|   ν∇u[5] |  8.310306072235107e-02|  9.359319210052490e-01|  5.054059028625488e-01|  2.460734993219376e-01|
# SC 0000000|My gradients|   ν∇u[6] |  3.096818923950195e-02|  9.983414411544800e-01|  4.543755650520325e-01|  3.094610571861267e-01|
# SC 0000000|My gradients|    κ∇θ[1 |  8.474481105804443e-02|  9.941806793212891e-01|  5.271573662757874e-01|  2.924559712409973e-01|
# SC 0000000|My gradients|    κ∇θ[2 |  1.205146312713623e-02|  9.935276508331299e-01|  4.710635840892792e-01|  2.964490056037903e-01|
# SC 0000000|My gradients|    κ∇θ[3 |  8.149802684783936e-02|  9.554433822631836e-01|  5.050389170646667e-01|  2.772010266780853e-01|
# SC 0000000|   My fields|     u[1] |  3.534454914728768e-02|  9.731187745702308e-01|  4.535663766733649e-01|  3.286224482235063e-01|
# SC 0000000|   My fields|     u[2] |  4.230166593202966e-02|  9.677995536192001e-01|  5.403072307285262e-01|  2.946031533277376e-01|
# SC 0000000|   My fields|     θ[1] |  6.236755817015882e-02|  9.765501230411475e-01|  5.160463124183342e-01|  2.819832441649039e-01|
# SC +++++++++++ClimateMachine StateCheck call-back end+++++++++++++++++++</pre><h2 id=".-Comparing-to-reference-values"><a class="docs-heading-anchor" href="#.-Comparing-to-reference-values">2. Comparing to reference values</a><a id=".-Comparing-to-reference-values-1"></a><a class="docs-heading-anchor-permalink" href="#.-Comparing-to-reference-values" title="Permalink"></a></h2><h3 id="Generate-arrays-of-reference-values"><a class="docs-heading-anchor" href="#Generate-arrays-of-reference-values">Generate arrays of reference values</a><a id="Generate-arrays-of-reference-values-1"></a><a class="docs-heading-anchor-permalink" href="#Generate-arrays-of-reference-values" title="Permalink"></a></h3><p>StateCheck functions can generate text that can be used to set the value of stored arrays that can be used in a reference test for subsequent regression testing. This involves 3 steps.</p><p><strong>Step 1.</strong> First a reference array setting program code is generated from the latest state of a given callback e.g.</p><pre><code class="language-julia">ClimateMachine.StateCheck.scprintref(cb)</code></pre><pre class="documenter-example-output"># BEGIN SCPRINT
# varr - reference values (from reference run)
# parr - digits match precision (hand edit as needed)
#
# [
#  [ MPIStateArray Name, Field Name, Maximum, Minimum, Mean, Standard Deviation ],
#  [         :                :          :        :      :          :           ],
# ]
varr = [
 [ &quot;My gradients&quot;, &quot;ν∇u[1]&quot;,  1.34348869323730468750e-04,  9.84732866287231445313e-01,  5.23545503616333007813e-01,  3.08209925889968872070e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[2]&quot;,  1.16317868232727050781e-01,  9.92088317871093750000e-01,  4.83800649642944335938e-01,  2.83350437879562377930e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[3]&quot;,  1.05845928192138671875e-03,  9.51775908470153808594e-01,  4.65474426746368408203e-01,  2.73615568876266479492e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[4]&quot;,  5.97668886184692382813e-02,  9.68048095703125000000e-01,  5.42618036270141601563e-01,  2.81570851802825927734e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[5]&quot;,  8.31030607223510742188e-02,  9.35931921005249023438e-01,  5.05405902862548828125e-01,  2.46073499321937561035e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[6]&quot;,  3.09681892395019531250e-02,  9.98341441154479980469e-01,  4.54375565052032470703e-01,  3.09461057186126708984e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[1]&quot;,  8.47448110580444335938e-02,  9.94180679321289062500e-01,  5.27157366275787353516e-01,  2.92455971240997314453e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[2]&quot;,  1.20514631271362304688e-02,  9.93527650833129882813e-01,  4.71063584089279174805e-01,  2.96449005603790283203e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[3]&quot;,  8.14980268478393554688e-02,  9.55443382263183593750e-01,  5.05038917064666748047e-01,  2.77201026678085327148e-01 ],
 [    &quot;My fields&quot;,   &quot;u[1]&quot;,  3.53445491472876849315e-02,  9.73118774570230771204e-01,  4.53566376673364857197e-01,  3.28622448223506280485e-01 ],
 [    &quot;My fields&quot;,   &quot;u[2]&quot;,  4.23016659320296639635e-02,  9.67799553619200114696e-01,  5.40307230728526155517e-01,  2.94603153327737565803e-01 ],
 [    &quot;My fields&quot;,   &quot;θ[1]&quot;,  6.23675581701588210848e-02,  9.76550123041147521974e-01,  5.16046312418334207628e-01,  2.81983244164903890105e-01 ],
]
parr = [
 [ &quot;My gradients&quot;, &quot;ν∇u[1]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[2]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[3]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[4]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[5]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[6]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[1]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[2]&quot;,    16,    16,    16,    16 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[3]&quot;,    16,    16,    16,    16 ],
 [    &quot;My fields&quot;,   &quot;u[1]&quot;,    16,    16,    16,    16 ],
 [    &quot;My fields&quot;,   &quot;u[2]&quot;,    16,    16,    16,    16 ],
 [    &quot;My fields&quot;,   &quot;θ[1]&quot;,    16,    16,    16,    16 ],
]
# END SCPRINT</pre><p><strong>Step 2.</strong> Next the array setting program code is executed (see below). At this stage the <em>parr[]</em> array context may be hand edited. The parr[] array sets a target number of decimal places for matching against reference values in <em>varr[]</em>. For different experiments and different fields the degree of precision that constitutes failing a regression test may vary. Choosing the <em>parr[]</em> values requires some sense as to the stability of the particular numerical and physical scenario an experiment represents. In the example below some precision settings have been hand edited from the default of 16 to illustrate the process.</p><pre><code class="language-julia">#! format: off
varr = [
 [ &quot;My gradients&quot;, &quot;ν∇u[1]&quot;,  1.34348869323730468750e-04,  9.84732866287231445313e-01,  5.23545503616333007813e-01,  3.08209930764271777814e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[2]&quot;,  1.16317868232727050781e-01,  9.92088317871093750000e-01,  4.83800649642944335938e-01,  2.83350456014221541157e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[3]&quot;,  1.05845928192138671875e-03,  9.51775908470153808594e-01,  4.65474426746368408203e-01,  2.73615551085745090099e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[4]&quot;,  5.97668886184692382813e-02,  9.68048095703125000000e-01,  5.42618036270141601563e-01,  2.81570862027933854765e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[5]&quot;,  8.31030607223510742188e-02,  9.35931921005249023438e-01,  5.05405902862548828125e-01,  2.46073509972619536290e-01 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[6]&quot;,  3.09681892395019531250e-02,  9.98341441154479980469e-01,  4.54375565052032470703e-01,  3.09461067853178561915e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[1]&quot;,  8.47448110580444335938e-02,  9.94180679321289062500e-01,  5.27157366275787353516e-01,  2.92455951648181833313e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[2]&quot;,  1.20514631271362304688e-02,  9.93527650833129882813e-01,  4.71063584089279174805e-01,  2.96449027197666359346e-01 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[3]&quot;,  8.14980268478393554688e-02,  9.55443382263183593750e-01,  5.05038917064666748047e-01,  2.77201022741208891187e-01 ],
 [    &quot;My fields&quot;,   &quot;u[1]&quot;,  4.31410233294131639781e-02,  9.97140933049696531754e-01,  4.62139750850942054861e-01,  3.23076684924287371725e-01 ],
 [    &quot;My fields&quot;,   &quot;u[2]&quot;,  1.01416659908237782872e-02,  9.14712023896926407218e-01,  4.76160523012988778913e-01,  2.71443440757963339038e-01 ],
 [    &quot;My fields&quot;,   &quot;θ[1]&quot;,  6.58965491052394547467e-02,  9.73216404386510802738e-01,  4.60007166313864512830e-01,  2.87310472114545079059e-01 ],
]
parr = [
 [ &quot;My gradients&quot;, &quot;ν∇u[1]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[2]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[3]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[4]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[5]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;ν∇u[6]&quot;,    16,     7,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[1]&quot;,    16,    16,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[2]&quot;,    16,    16,    16,     0 ],
 [ &quot;My gradients&quot;, &quot;κ∇θ[3]&quot;,    16,    16,    16,     0 ],
 [    &quot;My fields&quot;,   &quot;u[1]&quot;,    16,    16,    16,     0 ],
 [    &quot;My fields&quot;,   &quot;u[2]&quot;,    16,    16,    16,     0 ],
 [    &quot;My fields&quot;,   &quot;θ[1]&quot;,    16,    16,    16,     0 ],
]
#! format: on</code></pre><p><strong>Step 3.</strong> Finally a call-back stored value can be compared for consistency to with <em>parr[]</em> decimal places</p><pre><code class="language-julia">ClimateMachine.StateCheck.scdocheck(cb, (varr, parr))</code></pre><pre class="documenter-example-output"># SC +++++++++++ClimateMachine StateCheck ref val check start+++++++++++++++++
# SC &quot;N( )&quot; bracketing indicates field failed to match
# SC &quot;P=&quot;  row pass count
# SC &quot;F=&quot;  row failure count
# SC &quot;NA=&quot; row not checked count
# SC
# SC        Label         Field      min()      max()     mean()      std()
# SC My gradients,       ν∇u[1],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[2],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[3],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[4],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[5],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[6],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[1],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[2],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[3],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC    My fields,         u[1],      N(1),      N(3),      N(3),         0 :: P=2, F=3, NA=1
# SC    My fields,         u[2],      N(1),      N(3),      N(1),         0 :: P=2, F=3, NA=1
# SC    My fields,         θ[1],      N(3),      N(4),      N(1),         0 :: P=2, F=3, NA=1
# SC +++++++++++ClimateMachine StateCheck ref val check end+++++++++++++++++</pre><p>In this trivial case the match is guaranteed. The function will return <em>true</em> to the calling routine and this can be passed to an <code>@test</code> block.</p><p>However we can modify the reference test values to see the effect of a mismatch e.g.</p><pre><code class="language-julia">varr[1][3] = varr[1][3] * 10.0
ClimateMachine.StateCheck.scdocheck(cb, (varr, parr))</code></pre><pre class="documenter-example-output"># SC +++++++++++ClimateMachine StateCheck ref val check start+++++++++++++++++
# SC &quot;N( )&quot; bracketing indicates field failed to match
# SC &quot;P=&quot;  row pass count
# SC &quot;F=&quot;  row failure count
# SC &quot;NA=&quot; row not checked count
# SC
# SC        Label         Field      min()      max()     mean()      std()
# SC My gradients,       ν∇u[1],      N(0),        10,        19,         0 :: P=4, F=1, NA=1
# SC My gradients,       ν∇u[2],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[3],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[4],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[5],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       ν∇u[6],        19,        10,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[1],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[2],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC My gradients,       κ∇θ[3],        19,        19,        19,         0 :: P=5, F=0, NA=1
# SC    My fields,         u[1],      N(1),      N(3),      N(3),         0 :: P=2, F=3, NA=1
# SC    My fields,         u[2],      N(1),      N(3),      N(1),         0 :: P=2, F=3, NA=1
# SC    My fields,         θ[1],      N(3),      N(4),      N(1),         0 :: P=2, F=3, NA=1
# SC +++++++++++ClimateMachine StateCheck ref val check end+++++++++++++++++</pre><p>Here the mis-matching field is highlighted with <em>N(0)</em> indicating that the precision was not met and actual match length was (in this case) 0. If any field fails the test returns false for use in any regression testing control logic.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../Numerics/DGMethods/showcase_filters/">« Filters</a><a class="docs-footer-nextpage" href="../../../../HowToGuides/Common/Thermodynamics/">Thermodynamics »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 28 October 2020 19:59">Wednesday 28 October 2020</span>. Using Julia version 1.5.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
