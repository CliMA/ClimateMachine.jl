<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How to create an experiment with moisture and precipitation · ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><span class="tocitem">Tutorials</span></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../Common/UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../MoistureModelChoices/">Moisture model</a></li><li><a class="tocitem" href="../PrecipitationModelChoices/">Precipitation model</a></li><li class="is-active"><a class="tocitem" href>How to create an experiment with moisture and precipitation</a><ul class="internal"><li><a class="tocitem" href="#Representing-moisture-and-precipitation"><span>Representing moisture and precipitation</span></a></li><li><a class="tocitem" href="#Using-CLIMAParameters.jl"><span>Using CLIMAParameters.jl</span></a></li><li><a class="tocitem" href="#Initial-condition"><span>Initial condition</span></a></li><li><a class="tocitem" href="#Choosing-the-moisture-and-precipitation-models-and-sources"><span>Choosing the moisture and precipitation models and sources</span></a></li><li><a class="tocitem" href="#Boundary-conditions"><span>Boundary conditions</span></a></li><li><a class="tocitem" href="#Using-filters"><span>Using filters</span></a></li><li><a class="tocitem" href="#Accessing-moisture-and-precipitation-variables"><span>Accessing moisture and precipitation variables</span></a></li></ul></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-5-2" type="checkbox"/><label class="tocitem" for="menuitem-4-5-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/DGMethods/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-3" type="checkbox"/><label class="tocitem" for="menuitem-4-5-3"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-4" type="checkbox"/><label class="tocitem" for="menuitem-4-5-4"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Diagnostics/UsingDiagnostics/">Using Diagnostics</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../APIs/Land/Runoff/">Runoff Parameterizations</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/FVReconstructions/">Finite Volume Reconstructions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMF_plots/">EDMF Model</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../DevDocs/ModelVariableList/">Model variable list</a></li><li><a class="tocitem" href="../../../DevDocs/ModelOutput/">Model output</a></li><li><a class="tocitem" href="../../../DevDocs/DiagnosticVariableList/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li><li><a class="tocitem" href="../../../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How-to-guides</a></li><li><a class="is-disabled">Atmos</a></li><li class="is-active"><a href>How to create an experiment with moisture and precipitation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How to create an experiment with moisture and precipitation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/blob/master/docs/src/HowToGuides/Atmos/MoistureAndPrecip.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h2 id="Representing-moisture-and-precipitation"><a class="docs-heading-anchor" href="#Representing-moisture-and-precipitation">Representing moisture and precipitation</a><a id="Representing-moisture-and-precipitation-1"></a><a class="docs-heading-anchor-permalink" href="#Representing-moisture-and-precipitation" title="Permalink"></a></h2><p>This tutorial shows how to setup an Atmos experiment with moisture (i.e. water vapor, cloud liquid water, and cloud ice) and precipitation (i.e. rain and/or snow). It expands on the LES and GCM tutorials already available in the <a href="https://clima.github.io/ClimateMachine.jl/latest/generated/TutorialList/#Atmos">Atmos tutorials section</a>. Therefore, this tutorial only discusses additional steps that are needed in order to define an experiment with moisture and precipitation. For a tutorial on how to setup basic Atmos experiment see the <a href="https://clima.github.io/ClimateMachine.jl/latest/generated/Atmos/heldsuarez/">Held-Suarez</a> or the <a href="https://clima.github.io/ClimateMachine.jl/latest/generated/Atmos/risingbubble/">Rising thermal bubble</a> tutorials. For a full experiment setup with moisture and precipitation see the <a href="https://github.com/CliMA/ClimateMachine.jl/blob/master/experiments/AtmosLES/dycoms.jl">DyCOMS</a> or the <a href="https://github.com/CliMA/ClimateMachine.jl/blob/master/experiments/AtmosLES/squall_line.jl">Squall line</a> setups that are part of the Atmos model CI.</p><p>When setting up a moist and precipitating Atmos experiment, the user has to decide between two moisture and three precipitation models. The differences between the two moisture models are described in the <a href="https://clima.github.io/ClimateMachine.jl/latest/HowToGuides/Atmos/MoistureModelChoices/">Moisture model</a> section. In general, the <code>EquilMoist</code> model solves for only one additional state variable and diagnoses the cloud condensate partitioning between liquid and ice based on equilibrium assumptions and an iterative search algorithm. The <code>NonEquilMoist</code> model solves equations for all three cloud condensate state variables Because the condensation and deposition timescales are fast, in many cases, the <code>EquilMoist</code> model is a good approximation. However, it is obviously not sufficient when modeling nonequilibrium processes, such as supercooled clouds. Because of the lack of need for iterative search to perform partitioning of cloud condensate, the <code>NonEquilMoist</code> model might be more robust, if a little slower than the <code>EquilMoist</code> model. The differences between the three precipitation models are described in the <a href="https://clima.github.io/ClimateMachine.jl/latest/HowToGuides/Atmos/PrecipitationModelChoices/">Precipitation model</a> section. In general, the <code>NoPrecipitation</code> option can be used in simulations without precipitation or in simulations when the effect of precipitation is modeled by instantly removing cloud condensate. This option, coupled with either of the moisture models, is a good start when running in moist <code>AtmosGCM</code> configuration. The parameterization of instantaneous precipitation removal is described by the <a href="https://clima.github.io/ClimateMachine.jl/latest/Theory/Atmos/Microphysics_0M/">0-moment microphysics</a> scheme. The <code>RainModel</code> encapsulates the &quot;warm rain&quot; processes, i.e. the formation of precipitation in temperatures above freezing. The <code>RainSnowModel</code> describes the full set of microphysical processes leading to the formation of precipitation. Both models are based on <a href="https://clima.github.io/ClimateMachine.jl/latest/Theory/Atmos/Microphysics/">1-moment microphysics</a> scheme, which is a simple representation of cloud microphysics. It is a good starting point for the moist <code>AtmosLES</code> configurations, coupling to the subgrid scale parameterizations, and testing the machine learning pipelines. In the future, a more sophisticated 2-moment microphysics scheme will most likely be needed.</p><h2 id="Using-CLIMAParameters.jl"><a class="docs-heading-anchor" href="#Using-CLIMAParameters.jl">Using CLIMAParameters.jl</a><a id="Using-CLIMAParameters.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Using-CLIMAParameters.jl" title="Permalink"></a></h2><p>The microphysics parameterizations used to compute the sources and sinks for moisture and precipitation variables assume certain structure in the physical parameters used. This is done in order to leverage the dynamic dispatch mechanism and re-use the internal microphysics functions on different microphysics species based on their type. This structure has to be created when using different parameters from <a href="https://github.com/CliMA/CLIMAParameters.jl">CLIMAParameters.jl</a>.</p><pre><code class="language-julia">using CLIMAParameters
using CLIMAParameters.Planet
using CLIMAParameters.Atmos.Microphysics

struct LiquidParameterSet &lt;: AbstractLiquidParameterSet end
struct IceParameterSet &lt;: AbstractIceParameterSet end
struct RainParameterSet &lt;: AbstractRainParameterSet end
struct SnowParameterSet &lt;: AbstractSnowParameterSet end
struct MicropysicsParameterSet{L, I, R, S} &lt;: AbstractMicrophysicsParameterSet
    liq::L
    ice::I
    rai::R
    sno::S
end
struct EarthParameterSet{M} &lt;: AbstractEarthParameterSet
    microphys::M
end

const microphys = MicropysicsParameterSet(
    LiquidParameterSet(),
    IceParameterSet(),
    RainParameterSet(),
    SnowParameterSet(),
)
const param_set = EarthParameterSet(microphys)</code></pre><p>After this is done, the created <code>param_set</code> should be passed in the same way as in the &quot;dry&quot; tutorials.</p><h2 id="Initial-condition"><a class="docs-heading-anchor" href="#Initial-condition">Initial condition</a><a id="Initial-condition-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-condition" title="Permalink"></a></h2><p>As discussed in the documentation on the <a href="https://clima.github.io/ClimateMachine.jl/latest/HowToGuides/Atmos/MoistureModelChoices/">moisture</a> and <a href="https://clima.github.io/ClimateMachine.jl/latest/HowToGuides/Atmos/PrecipitationModelChoices/">precipitation</a> choices, different model configurations result in different state variables. When using the <code>EquilMoist</code> model, the initial condition on total water is the only thing that is needed:</p><pre><code class="language-julia">state.moisture.ρq_tot = ρ * 0.0042</code></pre><p>When using the <code>NonEquilMoist</code> model, the initial condition on total water, cloud liquid water and cloud ice is needed:</p><pre><code class="language-julia">state.moisture.ρq_tot = ρ * 0.0042
state.moisture.ρq_liq = FT(0)
state.moisture.ρq_ice = FT(0)</code></pre><p>Similarly for the <code>RainModel</code> we need to define the initial condition for rain:</p><pre><code class="language-julia">state.precipitation.ρq_rai = FT(0)</code></pre><p>And for the <code>RainSnowModel</code> the initial condition for both rain and snow is needed:</p><pre><code class="language-julia">state.precipitation.ρq_rai = FT(0)
state.precipitation.ρq_sno = FT(0)</code></pre><p>As in the previous tutorials <code>FT()</code> is the float type chosen for the simulation.</p><p>The moisture and precipitation state variables are grouped together into <code>state.moisture</code> and <code>state.precipitation</code> fields. As shown when specifying the initial condition, this hierarchy has to be observed when accessing the members of moisture or precipitation state variables.</p><h2 id="Choosing-the-moisture-and-precipitation-models-and-sources"><a class="docs-heading-anchor" href="#Choosing-the-moisture-and-precipitation-models-and-sources">Choosing the moisture and precipitation models and sources</a><a id="Choosing-the-moisture-and-precipitation-models-and-sources-1"></a><a class="docs-heading-anchor-permalink" href="#Choosing-the-moisture-and-precipitation-models-and-sources" title="Permalink"></a></h2><p>When opting to use the <code>EquilMoist</code> moisture model, we need to specify the maximum number of iterations and the tolerance allowed in the iterative search performed to diagnose cloud condensate phase partitioning. The cloud liquid water and cloud ice are stored in the auxiliary state variables. Because the partitioning is diagnosed, no additional source terms have to be specified:</p><pre><code class="language-julia">moisture = EquilMoist{FT}(; maxiter = 8, tolerance = FT(1e-1))</code></pre><p>Alternatively, when using the <code>NonEquilMoist</code> model, an additional source term <code>CreateClouds</code> is needed. It is assumed here that <code>source</code> lists all the previously defined source terms. We are splatting to it the additional cloud condensate sources for cloud liquid water and cloud ice.</p><pre><code class="language-julia">moisture = NonEquilMoist()
source = (source..., CreateClouds()...)</code></pre><p>If choosing the <code>NoPrecipitation</code> model we can either define no additional source terms (a true simulation without any representation of precipitation), or use the instant precipitation removal source term <code>RemovePrecipitation</code>. The boolean flag passed to it as argument chooses between two definitions of the threshold above which cloud condensate is removed, see <a href="https://clima.github.io/ClimateMachine.jl/latest/Theory/Atmos/Microphysics_0M/#Moisture-sink-due-to-precipitation">here</a>. The flag set to <code>true</code> results in cloud condensate based threshold. The flag set to <code>false</code> results in saturation excess threshold.</p><pre><code class="language-julia">precipitation = NoPrecipitation()
source = (source..., RemovePrecipitation(true)...)</code></pre><p>If using the <code>RainModel</code>, the <code>WarmRain_1M</code> source terms have to be chosen:</p><pre><code class="language-julia">precipitation = RainModel()
source = (source..., WarmRain_1M()...)</code></pre><p>Alternatively, if using the <code>RainSnowModel</code>, the <code>RainSnow_1M</code> source terms have to be chosen:</p><pre><code class="language-julia">precipitation = RainSnowModel()
source = (source..., RainSnow_1M()...)</code></pre><p>As in the previous tutorials, all of the <code>source</code>, <code>moisture</code>, <code>precipitation</code> choices, along with the <code>param_set</code> <code>struct</code> have to be passed to the Atmos model configuration:</p><pre><code class="language-julia">model = AtmosModel{FT}(
    AtmosLESConfigType,
    param_set;
    problem = problem,
    ref_state = ref_state,
    moisture = moisture,
    precipitation = precipitation,
    turbulence = SmagorinskyLilly{FT}(C_smag),
    source = source,
)</code></pre><h2 id="Boundary-conditions"><a class="docs-heading-anchor" href="#Boundary-conditions">Boundary conditions</a><a id="Boundary-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-conditions" title="Permalink"></a></h2><p>Boundary condition specification is currently undergoing a re-write. More details on boundary conditions will follow soon. By default no additional moisture or precipitation fluxes are applied.</p><h2 id="Using-filters"><a class="docs-heading-anchor" href="#Using-filters">Using filters</a><a id="Using-filters-1"></a><a class="docs-heading-anchor-permalink" href="#Using-filters" title="Permalink"></a></h2><p>All moisture and precipitation variables are positive definite. However, due to numerical errors, they can turn negative during the simulation. To mitigate that behavior it is advisable to use the <code>TMAR filter</code>. The filter adjust the nodal points inside the DG element. It truncates the negative nodal points to zero and adjusts the values of the remaining points to preserve the element average. To conserve mass of the advected tracers the <code>TMAR filter</code> should be combined with a flux-correction to those DG elements whose average value is negative. The flux-corrected option is currently being implemented. If mass conservation is deemed more important than positive sign of advected tracers, one can run the simulation without the <code>TMAR filter</code>. The microphysics functions are implemented such that <code>f(negative_argument) = f(0)</code>.</p><p>The list of state variables to be filtered depends on the moisture and precipitation model choices. For example:</p><pre><code class="language-julia">filter_vars = (&quot;moisture.ρq_tot&quot;,)
filter_vars = (filter_vars..., &quot;moisture.ρq_liq&quot;, &quot;moisture.ρq_ice&quot;)
filter_vars = (filter_vars..., &quot;precipitation.ρq_rai&quot;)
filter_vars = (filter_vars..., &quot;precipitation.ρq_rai&quot;, &quot;precipitation.ρq_sno&quot;)</code></pre><p>The list of variables to be filtered should then be passed to the <code>TMAR filter</code> <code>callback</code>:</p><pre><code class="language-julia">cbtmarfilter = GenericCallbacks.EveryXSimulationSteps(1) do
    Filters.apply!(
        solver_config.Q,
        filter_vars,
        solver_config.dg.grid,
        TMARFilter(),
    )
    nothing
end</code></pre><p>And the filter <code>callback</code> should be passed to the final <code>invoke</code> method:</p><pre><code class="language-julia">result = ClimateMachine.invoke!(
    solver_config;
    diagnostics_config = dgn_config,
    user_callbacks = (cbtmarfilter,),
    check_euclidean_distance = true,
)</code></pre><h2 id="Accessing-moisture-and-precipitation-variables"><a class="docs-heading-anchor" href="#Accessing-moisture-and-precipitation-variables">Accessing moisture and precipitation variables</a><a id="Accessing-moisture-and-precipitation-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Accessing-moisture-and-precipitation-variables" title="Permalink"></a></h2><p>To access moisture and precipitation variables at the end of the simulation (for example for some debugging or assert checking in the CI) we need to use the <code>varsindex</code> and <code>vars_state</code> functions:</p><pre><code class="language-julia">m = driver_config.bl
Q = solver_config.Q
ρ_ind = varsindex(vars_state(m, Prognostic(), FT), :ρ)

ρq_tot_ind = varsindex(vars_state(m, Prognostic(), FT), :moisture, :ρq_tot)
ρq_sno_ind = varsindex(vars_state(m, Prognostic(), FT), :precipitation, :ρq_sno)

min_q_tot = minimum(abs.(Array(Q[:, ρq_tot_ind, :]) ./ Array(Q[:, ρ_ind, :]),))
max_q_sno = maximum(abs.(Array(Q[:, ρq_sno_ind, :]) ./ Array(Q[:, ρ_ind, :]),))

@info(min_q_tot, max_q_sno)</code></pre><p>The vertical profiles (horizontal averages) of moisture and precipitation variables, their variances and covariances, as well as the liquid, ice rain and snow water paths are available in the output netcdf file when using the <code>setup_atmos_default_diagnostics</code> group. Additionally one can choose to save into the netcdf output all of the state variables and auxiliary variables using the <code>setup_dump_state_diagnostics</code> and <code>setup_dump_aux_diagnostics</code> groups.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../PrecipitationModelChoices/">« Precipitation model</a><a class="docs-footer-nextpage" href="../../Numerics/DGMethods/how_to_make_a_balance_law/">How to make a balance law »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 21 January 2021 00:44">Thursday 21 January 2021</span>. Using Julia version 1.5.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
