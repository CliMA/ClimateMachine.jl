<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Batched Generalized Minimal Residual · ClimateMachine</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-191640394-1', 'auto');
ga('send', 'pageview', {'page': location.pathname + location.search + location.hash});
</script><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../../GettingStarted/Terminology/">Terminology</a></li><li><a class="tocitem" href="../../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-4" type="checkbox"/><label class="tocitem" for="menuitem-2-4"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../TutorialList/">Home</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">BalanceLaws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../BalanceLaws/tendency_specification_layer/">Tendency specification</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Atmos/heldsuarez/">Dry Idealized GCM (Held-Suarez)</a></li><li><a class="tocitem" href="../../../Atmos/burgers_single_stack/">Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../../Atmos/burgers_single_stack_fvm/">Finite Volume Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../../Atmos/burgers_single_stack_bjfnk/">HEVI Single Element Stack Experiment (Burgers Equation)</a></li><li><a class="tocitem" href="../../../Atmos/densitycurrent/">LES Experiment (Density Current)</a></li><li><a class="tocitem" href="../../../Atmos/risingbubble/">LES Experiment (Rising Thermal Bubble)</a></li><li><a class="tocitem" href="../../../Atmos/agnesi_hs_lin/">Linear Hydrostatic Mountain (Topography)</a></li><li><a class="tocitem" href="../../../Atmos/agnesi_nh_lin/">Linear Non-Hydrostatic Mountain (Topography)</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-4-1" type="checkbox"/><label class="tocitem" for="menuitem-3-4-1"><span class="docs-label">Heat</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Land/Heat/heat_equation/">Heat Equation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4-2" type="checkbox"/><label class="tocitem" for="menuitem-3-4-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Land/Soil/Water/hydraulic_functions/">Hydraulic Functions</a></li><li><a class="tocitem" href="../../../Land/Soil/Heat/bonan_heat_tutorial/">Soil Heat Equation</a></li><li><a class="tocitem" href="../../../Land/Soil/Water/equilibrium_test/">Richards Equation</a></li><li><a class="tocitem" href="../../../Land/Soil/Coupled/equilibrium_test/">Coupled Water and Heat</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Ocean</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Ocean/geostrophic_adjustment/">One-dimensional geostrophic adjustment</a></li><li><a class="tocitem" href="../../../Ocean/internal_wave/">Propagating mode-1 internal wave</a></li><li><a class="tocitem" href="../../../Ocean/shear_instability/">Shear instability</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox" checked/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-6-1" type="checkbox" checked/><label class="tocitem" for="menuitem-3-6-1"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../cg/">Conjugate Gradient</a></li><li class="is-active"><a class="tocitem" href>Batched Generalized Minimal Residual</a><ul class="internal"><li><a class="tocitem" href="#What-is-the-Generalized-Minimal-Residual-Method?"><span>What is the Generalized Minimal Residual Method?</span></a></li><li><a class="tocitem" href="#What-is-the-Batched-Generalized-Minimal-Residual-Method?"><span>What is the Batched Generalized Minimal Residual Method?</span></a></li><li><a class="tocitem" href="#Basic-Example"><span>Basic Example</span></a></li><li><a class="tocitem" href="#Advanced-Example"><span>Advanced Example</span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-2" type="checkbox"/><label class="tocitem" for="menuitem-3-6-2"><span class="docs-label">DG Methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DGMethods/showcase_filters/">Filters</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-3" type="checkbox"/><label class="tocitem" for="menuitem-3-6-3"><span class="docs-label">Time-Stepping</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TimeStepping/ts_intro/">Introduction</a></li><li><input class="collapse-toggle" id="menuitem-3-6-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-6-3-2"><span class="docs-label">Explicit Runge-Kutta methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TimeStepping/explicit_lsrk/">Single-rate Explicit Timestepping</a></li><li><a class="tocitem" href="../../TimeStepping/tutorial_risingbubble_config/">Rising Thermal Bubble Configuration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-6-3-3"><span class="docs-label">Implicit-Explicit (IMEX) Additive Runge-Kutta methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TimeStepping/imex_ark/">Implicit-Explicit (IMEX) Additively-Partitioned Runge-Kutta Timestepping</a></li><li><a class="tocitem" href="../../TimeStepping/tutorial_acousticwave_config/">Acoustic Wave Configuration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-6-3-4"><span class="docs-label">Multirate Runge-Kutta methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TimeStepping/multirate_rk/">Multirate Runge-Kutta Timestepping</a></li><li><a class="tocitem" href="../../TimeStepping/tutorial_risingbubble_config/">Rising Thermal Bubble Configuration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-6-3-5"><span class="docs-label">MIS methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../TimeStepping/mis/">Multirate Infinitesimal Step (MIS) Timestepping</a></li><li><a class="tocitem" href="../../TimeStepping/tutorial_acousticwave_config/">Acoustic Wave Configuration</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-7-1" type="checkbox"/><label class="tocitem" for="menuitem-3-7-1"><span class="docs-label">Debug</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Diagnostics/Debug/StateCheck/">State Statistics Regression</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../../HowToGuides/Common/UniversalFunctions/">Universal Functions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/BalanceLaws/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Atmos/TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/AtmosReferenceState/">Reference profiles</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/MoistureModelChoices/">Moisture model</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/PrecipitationModelChoices/">Precipitation model</a></li><li><a class="tocitem" href="../../../../HowToGuides/Atmos/MoistureAndPrecip/">How to create an experiment with moisture and precipitation</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-6-2" type="checkbox"/><label class="tocitem" for="menuitem-4-6-2"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6-3" type="checkbox"/><label class="tocitem" for="menuitem-4-6-3"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-7" type="checkbox"/><label class="tocitem" for="menuitem-4-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../HowToGuides/Diagnostics/UsingDiagnostics/">Using Diagnostics</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Driver</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Driver/">Top level interface</a></li><li><a class="tocitem" href="../../../../APIs/Driver/Checkpoint/">Checkpoint</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/TemperatureProfiles/">Temperature Profiles</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Ocean/Ocean/">Ocean</a></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Land/LandModel/">Land Model</a></li><li><a class="tocitem" href="../../../../APIs/Land/Runoff/">Runoff Parameterizations</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilWaterParameterizations/">Soil Water Parameterizations</a></li><li><a class="tocitem" href="../../../../APIs/Land/SoilHeatParameterizations/">Soil Heat Parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-6" type="checkbox"/><label class="tocitem" for="menuitem-5-6"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Common/Orientations/">Orientations</a></li><li><a class="tocitem" href="../../../../APIs/Common/Spectra/">Spectra</a></li><li><a class="tocitem" href="../../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li><li><a class="tocitem" href="../../../../APIs/Common/Thermodynamics/">Thermodynamics</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceClosures/">Turbulence Closures</a></li><li><a class="tocitem" href="../../../../APIs/Common/TurbulenceConvection/">Turbulence Convection</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Balance Laws</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/BalanceLaws/BalanceLaws/">Balance Laws</a></li><li><a class="tocitem" href="../../../../APIs/BalanceLaws/Problems/">Problems</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-9" type="checkbox"/><label class="tocitem" for="menuitem-5-9"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Diagnostics/Diagnostics/">Diagnostics groups</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/DiagnosticsMachine/">DiagnosticsMachine</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/StdDiagnostics/">StdDiagnostics</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/StateCheck/">State Check</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-10" type="checkbox"/><label class="tocitem" for="menuitem-5-10"><span class="docs-label">Input/Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-11" type="checkbox"/><label class="tocitem" for="menuitem-5-11"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/DGMethods/">DG Methods</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/Courant/">Courant</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/NumericalFluxes/">Numerical Fluxes</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGMethods/FVReconstructions/">Finite Volume Reconstructions</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-12" type="checkbox"/><label class="tocitem" for="menuitem-5-12"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Utilities/VariableTemplates/">Variable Templates</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/SingleStackUtils/">Single Stack Utilities</a></li><li><a class="tocitem" href="../../../../APIs/Utilities/TicToc/">Tic Toc</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../../Theory/Common/Turbulence/">Turbulence Closures</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/EDMF_plots/">EDMF Model</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics_0M/">Microphysics_0M</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../../DevDocs/ModelVariableList/">Model variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/ModelOutput/">Model output</a></li><li><a class="tocitem" href="../../../../DevDocs/DiagnosticVariableList/">Diagnostic variable list</a></li><li><a class="tocitem" href="../../../../DevDocs/SystemImage/">Custom System Image</a></li></ul></li><li><a class="tocitem" href="../../../../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Numerics</a></li><li><a class="is-disabled">System Solvers</a></li><li class="is-active"><a href>Batched Generalized Minimal Residual</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Batched Generalized Minimal Residual</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/../../../../.." title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Batched-Generalized-Minimal-Residual"><a class="docs-heading-anchor" href="#Batched-Generalized-Minimal-Residual">Batched Generalized Minimal Residual</a><a id="Batched-Generalized-Minimal-Residual-1"></a><a class="docs-heading-anchor-permalink" href="#Batched-Generalized-Minimal-Residual" title="Permalink"></a></h1><p>In this tutorial we describe the basics of using the batched gmres iterative solver. At the end you should be able to</p><ol><li>Use BatchedGeneralizedMinimalResidual to solve batches of linear systems</li><li>Construct a columnwise linear solver with BatchedGeneralizedMinimalResidual</li></ol><h2 id="What-is-the-Generalized-Minimal-Residual-Method?"><a class="docs-heading-anchor" href="#What-is-the-Generalized-Minimal-Residual-Method?">What is the Generalized Minimal Residual Method?</a><a id="What-is-the-Generalized-Minimal-Residual-Method?-1"></a><a class="docs-heading-anchor-permalink" href="#What-is-the-Generalized-Minimal-Residual-Method?" title="Permalink"></a></h2><p>The  Generalized Minimal Residual Method (GMRES) is a <a href="https://en.wikipedia.org/wiki/Krylov_subspace">Krylov subspace</a> method for solving linear systems:</p><p class="math-container">\[ Ax = b\]</p><p>See the <a href="https://en.wikipedia.org/wiki/Generalized_minimal_residual_method">wikipedia</a> for more details.</p><h2 id="What-is-the-Batched-Generalized-Minimal-Residual-Method?"><a class="docs-heading-anchor" href="#What-is-the-Batched-Generalized-Minimal-Residual-Method?">What is the Batched Generalized Minimal Residual Method?</a><a id="What-is-the-Batched-Generalized-Minimal-Residual-Method?-1"></a><a class="docs-heading-anchor-permalink" href="#What-is-the-Batched-Generalized-Minimal-Residual-Method?" title="Permalink"></a></h2><p>As the name suggests it solves a whole bunch of independent GMRES problems</p><h2 id="Basic-Example"><a class="docs-heading-anchor" href="#Basic-Example">Basic Example</a><a id="Basic-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Example" title="Permalink"></a></h2><p>First we must load a few things</p><pre><code class="language-julia">using ClimateMachine
using ClimateMachine.SystemSolvers
using LinearAlgebra, Random, Plots</code></pre><p>Next we define two linear systems that we would like to solve simultaneously. The matrix for the first linear system is</p><pre><code class="language-julia">A1 = [
    2.0 -1.0 0.0
    -1.0 2.0 -1.0
    0.0 -1.0 2.0
];</code></pre><p>And the right hand side is</p><pre><code class="language-julia">b1 = ones(typeof(1.0), 3);</code></pre><p>The exact solution to the first linear system is</p><pre><code class="language-julia">x1_exact = [1.5, 2.0, 1.5];</code></pre><p>The matrix for the first linear system is</p><pre><code class="language-julia">A2 = [
    2.0 -1.0 0.0
    0.0 2.0 -1.0
    0.0 0.0 2.0
];</code></pre><p>And the right hand side is</p><pre><code class="language-julia">b2 = ones(typeof(1.0), 3);</code></pre><p>The exact solution to second linear system is</p><pre><code class="language-julia">x2_exact = [0.875, 0.75, 0.5];</code></pre><p>We now define a function that performs the action of each linear operator independently.</p><pre><code class="language-julia">function closure_linear_operator(A1, A2)
    function linear_operator!(x, y)
        mul!(view(x, :, 1), A1, view(y, :, 1))
        mul!(view(x, :, 2), A2, view(y, :, 2))
        return nothing
    end
    return linear_operator!
end;</code></pre><p>To understand how this works let us construct an instance of the linear operator and apply it to a vector</p><pre><code class="language-julia">linear_operator! = closure_linear_operator(A1, A2);</code></pre><p>Let us see what the action of this linear operator is</p><pre><code class="language-julia">y1 = ones(typeof(1.0), 3);
y2 = ones(typeof(1.0), 3) * 2.0;
y = [y1 y2];
x = copy(y);
linear_operator!(x, y);
x</code></pre><pre><code class="language-none">3×2 Array{Float64,2}:
 1.0  2.0
 0.0  2.0
 1.0  4.0</code></pre><p>We see that the first column is <code>A1 * [1 1 1]&#39;</code> and the second column is <code>A2 * [2 2 2]&#39;</code> that is,</p><pre><code class="language-julia">[A1 * y1 A2 * y2]</code></pre><pre><code class="language-none">3×2 Array{Float64,2}:
 1.0  2.0
 0.0  2.0
 1.0  4.0</code></pre><p>We are now ready to set up our Batched Generalized Minimal Residual solver We must now set up the right hand side of the linear system</p><pre><code class="language-julia">b = [b1 b2];</code></pre><p>as well as the exact solution, (to verify convergence)</p><pre><code class="language-julia">x_exact = [x1_exact x2_exact];</code></pre><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>For BatchedGeneralizedMinimalResidual the assumption is that each column of b is independent and corresponds to a batch. This will come back later.</p></div></div><p>We now use an instance of the solver</p><pre><code class="language-julia">linearsolver = BatchedGeneralizedMinimalResidual(b, size(A1, 1), 2);</code></pre><p>As well as an initial guess, denoted by the variable x</p><pre><code class="language-julia">x1 = ones(typeof(1.0), 3);
x2 = ones(typeof(1.0), 3);
x = [x1 x2];</code></pre><p>To solve the linear system, we just need to pass to the linearsolve! function</p><pre><code class="language-julia">iters = linearsolve!(linear_operator!, nothing, linearsolver, x, b)</code></pre><pre><code class="language-none">3</code></pre><p>which is guaranteed to converge in 3 iterations since <code>length(b1)=length(b2)=3</code> We can now check that the solution that we computed, x</p><pre><code class="language-julia">x</code></pre><pre><code class="language-none">3×2 Array{Float64,2}:
 1.5  0.875
 2.0  0.75
 1.5  0.5</code></pre><p>has converged to the exact solution</p><pre><code class="language-julia">x_exact</code></pre><pre><code class="language-none">3×2 Array{Float64,2}:
 1.5  0.875
 2.0  0.75
 1.5  0.5</code></pre><p>Which indeed it has.</p><h2 id="Advanced-Example"><a class="docs-heading-anchor" href="#Advanced-Example">Advanced Example</a><a id="Advanced-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Example" title="Permalink"></a></h2><p>We now go through a more advanced application of the Batched Generalized Minimal Residual solver</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Iterative methods should be used with preconditioners!</p></div></div><p>The first thing we do is define a linear operator that mimics the behavior of a columnwise operator in ClimateMachine</p><pre><code class="language-julia">function closure_linear_operator!(A, tup)
    function linear_operator!(y, x)
        alias_x = reshape(x, tup)
        alias_y = reshape(y, tup)
        for i6 in 1:tup[6]
            for i4 in 1:tup[4]
                for i2 in 1:tup[2]
                    for i1 in 1:tup[1]
                        tmp = alias_x[i1, i2, :, i4, :, i6][:]
                        tmp2 = A[i1, i2, i4, i6] * tmp
                        alias_y[i1, i2, :, i4, :, i6] .=
                            reshape(tmp2, (tup[3], tup[5]))
                    end
                end
            end
        end
    end
end;</code></pre><p>Next we define the array structure of an MPIStateArray in its true high dimensional form</p><pre><code class="language-julia">tup = (2, 2, 5, 2, 10, 2);</code></pre><p>We define our linear operator as a random matrix</p><pre><code class="language-julia">Random.seed!(1234);
B = [
    randn(tup[3] * tup[5], tup[3] * tup[5])
    for i1 in 1:tup[1], i2 in 1:tup[2], i4 in 1:tup[4], i6 in 1:tup[6]
];
columnwise_A = [
    B[i1, i2, i4, i6] + 3 * (i1 + i2 + i4 + i6) * I
    for i1 in 1:tup[1], i2 in 1:tup[2], i4 in 1:tup[4], i6 in 1:tup[6]
];</code></pre><p>as well as its inverse</p><pre><code class="language-julia">columnwise_inv_A = [
    inv(columnwise_A[i1, i2, i4, i6])
    for i1 in 1:tup[1], i2 in 1:tup[2], i4 in 1:tup[4], i6 in 1:tup[6]
];
columnwise_linear_operator! = closure_linear_operator!(columnwise_A, tup);
columnwise_inverse_linear_operator! =
    closure_linear_operator!(columnwise_inv_A, tup);</code></pre><p>The structure of an MPIStateArray is related to its true higher dimensional form as follows:</p><pre><code class="language-julia">mpi_tup = (tup[1] * tup[2] * tup[3], tup[4], tup[5] * tup[6]);</code></pre><p>We now define the right hand side of our Linear system</p><pre><code class="language-julia">b = randn(mpi_tup);</code></pre><p>As well as the initial guess</p><pre><code class="language-julia">x = copy(b);
x += randn(mpi_tup) * 0.1;</code></pre><p>In the previous tutorial we mentioned that it is assumed that the right hand side is an array whose column vectors all independent linear systems. But right now the array structure of <span>$x$</span> and <span>$b$</span> do not follow this requirement. To handle this case we must pass in additional arguments that tell the linear solver how to reconcile these differences. The first thing that the linear solver must know of is the higher tensor form of the MPIStateArray, which is just the <code>tup</code> from before</p><pre><code class="language-julia">reshape_tuple_f = tup;</code></pre><p>The second thing it needs to know is which indices correspond to a column and we want to make sure that these are the first set of indices that appear in the permutation tuple (which can be thought of as enacting a Tensor Transpose).</p><pre><code class="language-julia">permute_tuple_f = (5, 3, 4, 6, 1, 2);</code></pre><p>It has this format since the 3 and 5 index slots are the ones associated with traversing a column. And the 4 index slot corresponds to a state. We also need to tell our solver which kind of Array struct to use</p><pre><code class="language-julia">ArrayType = Array;</code></pre><p>We are now ready to finally define our linear solver, which uses a number of keyword arguments</p><pre><code class="language-julia">gmres = BatchedGeneralizedMinimalResidual(
    b,
    tup[3] * tup[5] * tup[4],
    tup[1] * tup[2] * tup[6];
    atol = eps(Float64) * 100,
    rtol = eps(Float64) * 100,
    forward_reshape = reshape_tuple_f,
    forward_permute = permute_tuple_f,
);</code></pre><p><code>m</code> is the number of gridpoints along a column. As mentioned previously, this is <code>tup[3]*tup[5]*tup[4]</code>. The <code>n</code> term corresponds to the batch size or the number of columns in this case. <code>atol</code> and <code>rtol</code> are relative and absolute tolerances</p><p>All the hard work is done, now we just call our linear solver</p><pre><code class="language-julia">iters = linearsolve!(
    columnwise_linear_operator!,
    nothing,
    gmres,
    x,
    b,
    max_iters = tup[3] * tup[5] * tup[4],
)</code></pre><pre><code class="language-none">52</code></pre><p>We see that it converged in less than <code>tup[3]*tup[5] = 50</code> iterations. Let us verify that it is indeed correct by computing the exact answer numerically and comparing it against the iterative solver.</p><pre><code class="language-julia">x_exact = copy(x);
columnwise_inverse_linear_operator!(x_exact, b);</code></pre><p>Now we can compare with some norms</p><pre><code class="language-julia">norm(x - x_exact) / norm(x_exact)
columnwise_linear_operator!(x_exact, x);
norm(x_exact - b) / norm(b)</code></pre><pre><code class="language-none">1.2827339696812677e-13</code></pre><p>Which we see are small, given our choice of <code>atol</code> and <code>rtol</code>. The struct also keeps a record of its convergence rate in the residual member (max over all batched solvers). The can be visualized via</p><pre><code class="language-julia">plot(log.(gmres.resnorms[:]) / log(10));
plot!(legend = false, xlims = (1, iters), ylims = (-15, 2));
plot!(ylabel = &quot;log10 residual&quot;, xlabel = &quot;iterations&quot;)</code></pre><p><img src="../1679607771.png" alt/></p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../cg/">« Conjugate Gradient</a><a class="docs-footer-nextpage" href="../../DGMethods/showcase_filters/">Filters »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 19 March 2021 20:34">Friday 19 March 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
