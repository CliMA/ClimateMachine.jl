# Positivity Preservation

It is important to preserve positive sign of active tracers,
  such as the mass fraction of the suspended or precipitating water.
The tracer mass may unphysically turn negative because of the
  numerical errors caused either by the advection scheme,
  or by time integration of source terms.
The scheme described here ensures positivity when solving
  advection problems and falls under the category
  of Maximum Principle Preserving (MPP) algorithms.
The algorithm is easily extended to include diffusion, and
ensuring positivity with source terms is left as future work.

The implementation follows
[Light\_and\_Durran\_2016](https://journals.ametsoc.org/mwr/article/144/12/4771/70817/Preserving-Nonnegativity-in-Discontinuous-Galerkin)
and
[Xiong\_et\_al\_2015](https://epubs.siam.org/doi/10.1137/140965326).
Positivity preservation is done in two steps:
  - Flux correction is applied to those DG elements,
    whose average value would otherwise turn negative
    at the end of the time step.
  - An adjustment is applied to nodal points inside the element
    that truncates the negative nodal points to zero
    and adjusts the values of the remaining points
    to preserve the element average.

The implemented MPP algorithm can be applied to a user-defined sub-set
of state variables, and there are several known limitations at this
time:

## Limitations

 - Positivity is ensured only at the last RK stage (stage values maybe
   negative)

 - The current implementation only supports use with the 2N
   low-storage Runge-Kutta methods (HOW TO ADD LINK?). The
   method is easily extended to other explicit Runge-Kutta methods,
   extension to the implicit methods (included the implicit part of
   implicit-explicit methods), is possible but requires more code
   development.

 - The current implementation assumes that each of the fields which
   the MPP algorithm is applied to is advected with the same velocity
   field.

 - It is assumed that the finite volume method is positivity
   preserving with a forward Euler step with the given time step; the
   finite volume cells are the same as the elements used for the
   discontinuous Galerkin method.

 - Currently only periodic and zero Dirchlet boundary conditions are
   supported

## Flux correction

The flux correction is implemented following
  [Xiong\_et\_al\_2015](https://epubs.siam.org/doi/10.1137/140965326)
  which ensures positivity of the total mass in a cell.
The basic idea of the algorithm is advance the solution one full time
  step using the high order discontinuous Galerkin method and then, if
  necessary, correct the element average value using a low order (MPP)
  finite volume method.
Importantly, the flux correction technique only ensures that the
  average value is within the bounds and the nodal values are
  corrected using rescaling approach described below.
Note that the correction is only applied at the end of a time step
  (not each of the individual stage values of multistep methods).

Below we show the algorithm for the 1-dimensional case.

Let ``H_{j+\frac{1}{2}}`` denote the total flux through face 
  ``j + \frac{1}{2}`` of element ``j`` generated by the discontinuous
  Galerkin scheme during the timestep.
Similarly, let ``h_{j+\frac{1}{2}}`` denote the total flux that would
  result from a positivity preserving finite volume method (with a
  forward Euler step) through the same face.
Additionally, let quantity
```math
  F_{j+\frac{1}{2}} = H_{j+\frac{1}{2}} - h_{j+\frac{1}{2}}
```
denote the difference between the two fluxes.
The basic idea of the flux correction scheme is to replace the
discontinuous Galerkin flux with a corrected
``\hat{H}_{j+\frac{1}{2}}``
```math
\hat{H}_{j+\frac{1}{2}} = \theta_{j+\frac{1}{2}} H_{j+\frac{1}{2}} + (1 - \theta_{j+\frac{1}{2}}) h_{j+\frac{1}{2}}
```
where ``0 \le \theta_{j+\frac{1}{2}} \le 1`` with the limit right
  limit results in the discontinuous Galerkin flux and the left limit
  the finite volume flux.

The crux of the scheme is choosing a value for
  ``\theta_{j+\frac{1}{2}}`` that is as close to ``1`` as possible
  that ensures that the cell average does not become negative.
Namely, if using ``H_{j+\frac{1}{2}}`` does not either element ``j``
  or ``j+1`` to have a negative average then
  ``\theta_{j+\frac{1}{2}} = 1``.
If either of these elements would be negative then
```math
\theta_{j+\frac{1}{2}} = \min(\Lambda_{j}, \Lambda_{j+1})
```
where ``\Lambda_{j}`` and ``\Lambda_{j+1}`` roughly correspond to the
  fraction of the discontinuous Galerkin flux that can be allowed to
  be used for elements ``j`` and ``j+1``, respectively.
These helper limiters are defined as
```math
\Lambda_{j} = \frac{\phi^{t+1}_{j, FV} - \phi_{\min}}{\Delta t \Delta F_{j, out}}
```
where:
 - ``\phi_{\min} = 0`` is the minimum allowed value
 - ``\phi^{n+1}_{j, FV} = \phi^{n}_{j} - \Delta t (h_{j+\frac{1}{2}} - h_{j-\frac{1}{2}})``
     is finite volume update for element ``j`` for the total mass
     ``\phi^{n}_{j}``
 - ``\Delta F_{j, out} = \max(0, F_{j+\frac{1}{2}}) - \min(0, F_{j-\frac{1}{2}})``
     is the sum of the flux differences between the DG and FV schemes
     for element ``j``, but only those contributions where DG overestimates
     the flux compared to FV
 - ``\Delta t`` is the model time step
The numerator represents the maximum scalar concentration that can be
  moved out of the DG element in a given time step, based on the FV
  scheme.
The denominator sums the "overshoots" from the DG scheme
  compared to the FV scheme that would result in negative average
  element value.
Notice that the limiter on the ``j+\frac{1}{2}`` face potentially depends
  on all the fluxes going in/out of the element ``j``.
The MPP implementation requires additional memory allocated to store the
  FV solutions for all elements and the limiters on all the element faces.
See [Xiong\_et\_al\_2015](https://epubs.siam.org/doi/10.1137/140965326)
  for the full derivation
  (eq. 2.12 and above define the limiters in a more detailed way).

## Rescaling

The rescaling is implemented following
  [Light\_and\_Durran\_2016](https://journals.ametsoc.org/mwr/article/144/12/4771/70817/Preserving-Nonnegativity-in-Discontinuous-Galerkin)
  Chapter 3.
For scalar ``\phi`` in DG element ``j`` with nodal points ``k``
  the truncation is:
```math
\phi_{j,k}^{+} = \left\{
    \begin{array}{ll}
        \phi_{j,k} & \mathrm{if} \;\; \phi_{j,k} \geq 0 \\
        0 & \mathrm{if} \;\; \phi_{j,k} < 0
    \end{array}
\right.
```
The rescaling factor is computed as:
```math
r_j = \frac{\overline{\phi_j}}{\overline{\phi_j^+}}
```
where:
 - ``\overline{\phi_{j}}`` and ``\overline{\phi_j^+}`` denote the average
   element value before and after the truncation.
Finally, the rescaled nodal point values
``\phi_{j,k}^{*}`` are defined as:
```math
\phi_{j,k}^{*} = \left\{
    \begin{array}{ll}
        r_j \phi_{j,k} & \mathrm{if} \;\; \phi_{j,k} \geq 0 \\
        0 & \mathrm{if} \;\; \phi_{j,k} < 0
    \end{array}
\right.
```
The flux correction guarantees that the average element value is non-negative.
Because of this, the above truncation and mass adjustment, will not introduce
  any additional mass into the system.

## Possible Extensions

 - This approach could potentially be extended to offer a local limiter,
   along the lines of limiters for finite volume schemes in
   [Smolarkiewicz\_1989](https://journals.ametsoc.org/mwr/article/117/11/2626/64201/Comment-on-A-Positive-Definite-Advection-Scheme).
   Such application for DG is not described in the literature.
   Not sure how effective it would be.
   For our application one would have to additionally deal with
   divergence and CFL > 1.

## Results

TODO - Once the interface with CliMA is implemented I'll add here a
  test/usage example.
It will either be the 1D-box filter showcase
  or the cone test from Light and Durran 2016.
